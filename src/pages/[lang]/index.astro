---
/**
 * src/pages/[lang]/index.astro
 * - ดึง Hero (title, subtitle, image) จาก WPGraphQL
 * - รองรับกรณีภาษา default บน WP ไม่มี prefix (เช่น "/" แทน "/en/")
 * - แสดงคอมเมนต์ดีบักว่าดึงข้อมูลจาก URI ไหน
 */
import Layout from "../../layouts/Layout.astro";
import HOME_QUERY from "../../queries/home";
import { wpQuery } from "../../lib/wp";

export async function getStaticPaths() {
  return [{ params: { lang: "th" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params as { lang: "th" | "en" };

// candidate URIs ที่จะลองถาม WP ตามภาษา (จัดลำดับความเป็นไปได้)
const candidates = lang === "en"
  ? ["/en/", "/", "/en"] // อังกฤษอาจเป็น root
  : ["/th/", "/th"];     // ไทยมักจะมี prefix

type GqlHeroImage = {
  node?: {
    sourceUrl?: string;
    altText?: string;
  };
};
type GqlHero = {
  heroTitle?: string | null;
  heroSubtitle?: string | null;
  heroImage?: GqlHeroImage | null;
};
type GqlData = {
  nodeByUri?: {
    hero?: GqlHero | null;
  } | null;
};

// ค่า fallback เผื่อยังตั้งค่า WP ไม่ครบ
const FALLBACK_BG = "/assets/background.svg";

let heroTitle = lang === "en" ? "Smart Bed" : "Smart Bed (TH)";
let heroSubtitle =
  lang === "en"
    ? "Innovative Care for the Ones Your loved ones"
    : "การดูแลที่สร้างสรรค์เพื่อคนที่คุณรัก";
let heroBg = FALLBACK_BG;
let usedUri: string | null = null;

// ฟังก์ชันลองดึงจากหลาย URI จนเจอ
async function loadHeroFromWp() {
  for (const uri of candidates) {
    try {
      const data = await wpQuery<GqlData>(HOME_QUERY, { uri });
      const hero = data?.nodeByUri?.hero ?? null;
      const img = hero?.heroImage?.node?.sourceUrl ?? null;

      // ถ้ามีรูป ถือว่าหน้านี้คือที่ใช่
      if (img) {
        usedUri = uri;
        heroBg = img;
        heroTitle = hero?.heroTitle ?? heroTitle;
        heroSubtitle = hero?.heroSubtitle ?? heroSubtitle;
        return;
      }

      // บางทีไม่มีรูป แต่มี title/subtitle ก็ถือว่าเจอหน้า
      if (hero) {
        usedUri = uri;
        heroTitle = hero?.heroTitle ?? heroTitle;
        heroSubtitle = hero?.heroSubtitle ?? heroSubtitle;
        // ยังไม่มีรูปก็ใช้ fallback ต่อไป
        return;
      }
    } catch (e) {
      // ลองตัวถัดไป
      console.error(`[HOME] WP fetch failed for ${uri}:`, e);
    }
  }
}

await loadHeroFromWp();

/* ===== CTA / SEO ===== */
const ctaText = lang === "en" ? "Contact Us" : "ติดต่อเรา";
const ctaHref = lang === "en" ? "/en#contact" : "/th#contact";

const alternates = [
  { lang: "th", url: "/th" },
  { lang: "en", url: "/en" },
];

const pageTitle = heroTitle;
const pageDesc =
  lang === "en"
    ? "Smart bed solutions for modern healthcare."
    : "โซลูชันเตียงอัจฉริยะเพื่อการดูแลสุขภาพยุคใหม่";
---

<!-- DEBUG: ถ้าอยากเช็คว่าเราใช้ URI อะไร ให้เปิด devtools ดู HTML comments -->
<!-- Used WP URI: {usedUri ?? "NONE (fallback only)"} -->
<!-- Hero BG: {heroBg} -->

<Layout lang={lang} alternates={alternates} title={pageTitle} description={pageDesc}>
  <!-- ============== HERO ============== -->
  <section
    class="relative overflow-hidden"
    style={`background-image: url('${heroBg}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;`}
  >
    <!-- overlay ให้โทนฟ้าแบบดีไซน์ แต่ยังเห็นภาพด้านหลัง -->
    <div class="absolute inset-0 bg-gradient-to-br from-sky-500/60 via-sky-500/50 to-blue-600/40"></div>

    <div class="relative z-10 max-w-6xl mx-auto px-6 md:px-8 py-24 md:py-32">
      <h1 class="text-white text-5xl md:text-6xl font-extrabold tracking-tight mb-6">
        {heroTitle}
      </h1>

      <p class="text-white/95 text-xl md:text-2xl max-w-2xl leading-relaxed mb-10">
        {heroSubtitle}
      </p>

      <a
        href={ctaHref}
        class="inline-flex items-center gap-2 bg-white text-blue-700 font-semibold px-7 py-4 rounded-full shadow-lg hover:shadow-xl transition"
      >
        {ctaText}
        <span aria-hidden="true">→</span>
      </a>
    </div>

    <div class="h-8"></div>
  </section>

  <!-- ============== SECTION ตัวอย่าง ============== -->
  <section class="max-w-6xl mx-auto px-6 md:px-8 py-16 md:py-24">
    <h2 class="text-2xl md:text-3xl font-bold mb-4">
      {lang === "en" ? "Why Choose Us" : "ทำไมต้องเลือกเรา"}
    </h2>
    <p class="text-gray-600 leading-relaxed max-w-3xl">
      {lang === "en"
        ? "We design and deliver dependable smart bed solutions to elevate patient comfort and caregiver efficiency."
        : "เราออกแบบและส่งมอบโซลูชันเตียงอัจฉริยะที่เชื่อถือได้ เพื่อยกระดับความสบายของผู้ป่วยและประสิทธิภาพของผู้ดูแล"}
    </p>
  </section>
</Layout>
