---
import Layout from "../../layouts/Layout.astro";
import HOME_QUERY from "../../queries/home";
import { wpQuery } from "../../lib/wp";
import { rewriteWpUrl } from "../../lib/wpUrl";

export async function getStaticPaths() {
  return [{ params: { lang: "th" } }, { params: { lang: "en" } }];
}

const { lang } = Astro.params as { lang: "th" | "en" };

// ลองหลาย URI เพื่อหาเพจ Home ต่อภาษา (แก้ให้ตรง permalink จริงได้)
const uriCandidates =
  lang === "en"
    ? ["/en/", "/home/", "/home", "/"]
    : ["/", "/หน้าแรก/", "/หน้าแรก", "/th/"];

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined {
  return img?.node ? img.node : img ?? undefined;
}

function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

let heroTitle = "";
let heroImgUrl = "";

for (const uri of uriCandidates) {
  try {
    const data = await wpQuery<any>(HOME_QUERY, { uri });
    const hero = data?.nodeByUri?.hero;
    if (!hero) continue;

    // ใช้ชื่อฟิลด์ตัวเล็กให้ตรง schema
    heroTitle = hero?.herotitle ?? heroTitle;
    heroImgUrl = pickImageUrl(hero?.heroimage) ?? heroImgUrl;

    if (heroTitle || heroImgUrl) break;
  } catch (e) {
    console.warn("[Hero] fetch failed for", uri, e);
  }
}

if (!heroTitle) {
  heroTitle =
    lang === "en"
      ? "Shaping the future of healthcare"
      : "ร่วมสร้างอนาคตใหม่ แห่งการดูแลสุขภาพ";
}
---

<Layout lang={lang} showNavLinks={true} alternates={[{lang:"th",url:"/th"},{lang:"en",url:"/en"}]}>
  <section class="relative overflow-hidden min-h-screen">
    <div class="absolute inset-0 -z-10">
      {heroImgUrl ? (
        <img src={heroImgUrl} alt="" class="w-full h-full object-cover object-center" loading="eager" />
      ) : (
        <div class="w-full h-full bg-gradient-to-br from-sky-400 via-blue-500 to-cyan-400" />
      )}
      <div class="absolute inset-0 bg-black/40" />
    </div>

    <div class="max-w-5xl mx-auto px-6 lg:px-12 min-h-screen flex items-center">
      <h1 class="text-white text-5xl md:text-6xl lg:text-7xl font-bold leading-tight whitespace-pre-line drop-shadow-[0_6px_24px_rgba(0,0,0,0.65)]">
        {heroTitle}
      </h1>
    </div>
  </section>
</Layout>
