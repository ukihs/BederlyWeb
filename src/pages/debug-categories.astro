---
// src/pages/debug-categories.astro - ‡∏î‡∏π categories ‡πÅ‡∏•‡∏∞ posts ‡πÉ‡∏ô WordPress
import { wpQuery } from "../lib/wp";

// Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π categories ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const CATEGORIES_QUERY = /* GraphQL */ `
  query AllCategories {
    categories(first: 50) {
      nodes {
        id
        name
        slug
        count
        posts(first: 10) {
          nodes {
            id
            title
            language {
              code
              name
            }
            featuredImage {
              node {
                sourceUrl
                altText
              }
            }
          }
        }
      }
    }
  }
`;

// Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π posts ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
const POSTS_BY_LANGUAGE = /* GraphQL */ `
  query PostsByLanguage($language: LanguageCodeFilterEnum!) {
    posts(first: 20, where: { language: $language, status: PUBLISH }) {
      nodes {
        id
        title
        language { code name }
        categories {
          nodes { name slug }
        }
        featuredImage {
          node {
            sourceUrl
            altText
          }
        }
      }
    }
  }
`;

// Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö Hero category ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
const HERO_TEST_QUERY = /* GraphQL */ `
  query HeroTest($category: String!) {
    posts(first: 10, where: { categoryName: $category, status: PUBLISH }) {
      nodes {
        id
        title
        language { code name }
        categories {
          nodes { name slug }
        }
        featuredImage {
          node {
            sourceUrl
            altText
          }
        }
      }
    }
  }
`;

let categoriesResult = null;
let postsEN = null;
let postsTH = null;
let heroTestResults = [];

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• categories ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
try {
  categoriesResult = await wpQuery<any>(CATEGORIES_QUERY);
} catch (e) {
  categoriesResult = { error: e.message };
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• posts ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
try {
  postsEN = await wpQuery<any>(POSTS_BY_LANGUAGE, { language: "EN" });
} catch (e) {
  postsEN = { error: e.message };
}

try {
  postsTH = await wpQuery<any>(POSTS_BY_LANGUAGE, { language: "TH" });
} catch (e) {
  postsTH = { error: e.message };
}

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Hero category ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö
const heroVariations = ["Hero", "hero", "HERO", "‡∏Æ‡∏µ‡πÇ‡∏£‡πà", "‡∏Æ‡∏µ‡πÇ‡∏£"];
for (const variation of heroVariations) {
  try {
    const result = await wpQuery<any>(HERO_TEST_QUERY, { category: variation });
    heroTestResults.push({ 
      category: variation, 
      posts: result?.posts?.nodes || [], 
      success: true 
    });
  } catch (e) {
    heroTestResults.push({ 
      category: variation, 
      error: e.message, 
      success: false 
    });
  }
}

// ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
const allCategories = categoriesResult?.categories?.nodes || [];
const categoriesWithPosts = allCategories.filter(cat => cat.count > 0);
const heroCategory = allCategories.find(cat => cat.name.toLowerCase().includes('hero'));
---

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug Categories & Hero</title>
  <style>
    body { 
      font-family: system-ui; 
      padding: 2rem; 
      line-height: 1.6; 
      background: #f8f9fa;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .section { 
      margin: 2rem 0; 
      padding: 1.5rem; 
      border: 1px solid #ddd; 
      border-radius: 12px; 
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { border-color: #22c55e; background: #f0fdf4; }
    .error { border-color: #ef4444; background: #fef2f2; }
    .warning { border-color: #f59e0b; background: #fffbeb; }
    .info { border-color: #3b82f6; background: #eff6ff; }
    pre { 
      background: #1e293b; 
      color: #e2e8f0;
      padding: 1rem; 
      border-radius: 8px; 
      overflow-x: auto; 
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    .highlight { background: #fef3c7; padding: 2px 4px; border-radius: 4px; font-weight: 600; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    @media (max-width: 768px) { .grid, .grid-3 { grid-template-columns: 1fr; } }
    .badge { 
      display: inline-block; 
      padding: 4px 8px; 
      border-radius: 12px; 
      font-size: 12px; 
      font-weight: 600; 
      text-transform: uppercase; 
    }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-error { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .category-card {
      padding: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin: 0.5rem 0;
      background: #f9fafb;
    }
    .post-item {
      padding: 0.5rem;
      border-left: 3px solid #3b82f6;
      background: #f8fafc;
      margin: 0.25rem 0;
      font-size: 0.9rem;
    }
    .solution {
      background: #f0fdf4;
      border: 2px solid #22c55e;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç WordPress Categories & Hero Debug</h1>
    
    <!-- Summary -->
    <div class="section info">
      <h2>üìä Quick Summary</h2>
      <div class="grid-3">
        <div>
          <strong>Total Categories:</strong> {allCategories.length}<br>
          <strong>With Posts:</strong> {categoriesWithPosts.length}
        </div>
        <div>
          <strong>EN Posts:</strong> {postsEN?.posts?.nodes?.length || 0}<br>
          <strong>TH Posts:</strong> {postsTH?.posts?.nodes?.length || 0}
        </div>
        <div>
          <strong>Hero Found:</strong> {heroCategory ? '‚úÖ Yes' : '‚ùå No'}<br>
          <strong>Hero Posts:</strong> {heroCategory?.count || 0}
        </div>
      </div>
    </div>

    <!-- Hero Category Tests -->
    <div class={`section ${heroTestResults.some(r => r.success && r.posts.length > 0) ? 'success' : 'warning'}`}>
      <h2>üéØ Hero Category Tests</h2>
      <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ Hero category ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö:</p>
      
      {heroTestResults.map((test, index) => (
        <div key={index} class="category-card">
          <h3>
            Category: "<strong>{test.category}</strong>"
            {test.success ? (
              <span class={`badge ${test.posts.length > 0 ? 'badge-success' : 'badge-info'}`}>
                {test.posts.length} posts
              </span>
            ) : (
              <span class="badge badge-error">Error</span>
            )}
          </h3>
          
          {test.success ? (
            test.posts.length > 0 ? (
              <div>
                {test.posts.slice(0, 3).map((post, i) => (
                  <div key={i} class="post-item">
                    <strong>{post.title}</strong> 
                    ({post.language?.code || 'No Lang'})
                    {post.featuredImage?.node?.sourceUrl && ' üñºÔ∏è'}
                  </div>
                ))}
                {test.posts.length > 3 && <p class="text-sm text-gray-600">...and {test.posts.length - 3} more</p>}
              </div>
            ) : (
              <p class="text-gray-600">No posts found in this category</p>
            )
          ) : (
            <p class="text-red-600">Error: {test.error}</p>
          )}
        </div>
      ))}
    </div>

    <!-- All Categories -->
    <div class="section">
      <h2>üìÇ All Categories ({allCategories.length})</h2>
      <div class="grid">
        <div>
          <h3>Categories with Posts ({categoriesWithPosts.length})</h3>
          {categoriesWithPosts.map((cat, index) => (
            <div key={index} class="category-card">
              <div>
                <strong>{cat.name}</strong> 
                <span class="badge badge-info">{cat.count} posts</span>
              </div>
              <div class="text-sm text-gray-600">Slug: {cat.slug}</div>
              {cat.posts.nodes.slice(0, 2).map((post, i) => (
                <div key={i} class="post-item">
                  {post.title} ({post.language?.code || 'No Lang'})
                </div>
              ))}
            </div>
          ))}
        </div>
        
        <div>
          <h3>Empty Categories</h3>
          {allCategories.filter(cat => cat.count === 0).map((cat, index) => (
            <div key={index} class="category-card">
              <strong>{cat.name}</strong> <span class="badge badge-error">0 posts</span>
              <div class="text-sm text-gray-600">Slug: {cat.slug}</div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Posts by Language -->
    <div class="section">
      <h2>üåê Posts by Language</h2>
      <div class="grid">
        <div>
          <h3>English Posts ({postsEN?.posts?.nodes?.length || 0})</h3>
          {postsEN?.posts?.nodes?.slice(0, 5).map((post, index) => (
            <div key={index} class="post-item">
              <strong>{post.title}</strong>
              <div class="text-sm">
                Categories: {post.categories.nodes.map(cat => cat.name).join(', ') || 'None'}
                {post.featuredImage?.node?.sourceUrl && ' üñºÔ∏è'}
              </div>
            </div>
          ))}
        </div>
        
        <div>
          <h3>Thai Posts ({postsTH?.posts?.nodes?.length || 0})</h3>
          {postsTH?.posts?.nodes?.slice(0, 5).map((post, index) => (
            <div key={index} class="post-item">
              <strong>{post.title}</strong>
              <div class="text-sm">
                Categories: {post.categories.nodes.map(cat => cat.name).join(', ') || 'None'}
                {post.featuredImage?.node?.sourceUrl && ' üñºÔ∏è'}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Solution -->
    <div class="solution">
      <h2>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h2>
      
      {heroTestResults.some(r => r.success && r.posts.length > 0) ? (
        <div>
          <h3>‚úÖ ‡∏û‡∏ö Hero category ‡πÅ‡∏•‡πâ‡∏ß!</h3>
          <p>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏ô Hero category ‡πÅ‡∏•‡πâ‡∏ß ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô:</p>
          <ol>
            <li><strong>Language filter:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
            <li><strong>Featured Image:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</li>
            <li><strong>Status:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏û‡∏™‡∏ï‡πå publish ‡πÅ‡∏•‡πâ‡∏ß</li>
          </ol>
        </div>
      ) : heroCategory ? (
        <div>
          <h3>‚ö†Ô∏è ‡∏°‡∏µ Hero category ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</h3>
          <p><strong>Category name:</strong> <span class="highlight">{heroCategory.name}</span></p>
          <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</strong></p>
          <ol>
            <li>‡πÄ‡∏Ç‡πâ‡∏≤ WordPress Admin ‚Üí Posts ‚Üí Add New</li>
            <li>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Category ‡πÄ‡∏õ‡πá‡∏ô "{heroCategory.name}"</li>
            <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ (EN/TH) ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ WPML</li>
            <li>Publish ‡πÇ‡∏û‡∏™‡∏ï‡πå</li>
          </ol>
        </div>
      ) : (
        <div>
          <h3>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Hero category</h3>
          <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</strong></p>
          <ol>
            <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á Category:</strong> WordPress Admin ‚Üí Posts ‚Üí Categories ‚Üí Add New</li>
            <li><strong>Name:</strong> Hero</li>
            <li><strong>Slug:</strong> hero</li>
            <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå:</strong> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î Hero</li>
            <li><strong>‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠:</strong> ‡πÅ‡∏Å‡πâ HeroCategoryImages.astro ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ category ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß</li>
          </ol>
          
          <p><strong>Categories ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß:</strong></p>
          <ul>
            {categoriesWithPosts.map((cat, index) => (
              <li key={index}>
                <code>{cat.name}</code> ({cat.count} posts)
              </li>
            ))}
          </ul>
        </div>
      )}
      
      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #d1d5db;">
        <p><strong>üöÄ ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß:</strong></p>
        <ol>
          <li>‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå debug-categories.astro</li>
          <li><a href="/th" style="color: #2563eb;">‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å</a></li>
        </ol>
      </div>
    </div>

    <!-- Raw Data -->
    <div class="section">
      <h2>üìã Raw Data (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Debug)</h2>
      <details>
        <summary>All Categories Result</summary>
        <pre>{JSON.stringify(categoriesResult, null, 2)}</pre>
      </details>
      <details>
        <summary>Hero Test Results</summary>
        <pre>{JSON.stringify(heroTestResults, null, 2)}</pre>
      </details>
    </div>
  </div>
</body>
</html>