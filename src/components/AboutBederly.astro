---
import { wpQuery } from "../lib/wp";

export interface Props {
  lang: "th" | "en";
  pageUriTH?: string;
  pageUriEN?: string;
}

const {
  lang,
  pageUriTH = "/",
  pageUriEN = "/en/welcome/",
} = Astro.props;

const ABOUT_BY_URI = /* GraphQL */ `
  query AboutByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        id
        title
        uri
        language { code }
        about {
          aboutTitle
          aboutBody
          aboutYoutubeUrl
        }
      }
    }
  }
`;

const uri = lang === "en" ? pageUriEN : pageUriTH;

let title = "";
let body = "";
let youtubeUrl = "";
let hasData = false;
let gqlError = "";

try {
  const res = await wpQuery<any>(ABOUT_BY_URI, { uri });
  const page = res?.nodeByUri;
  const about = page?.about;

  if (about) {
    title = about.aboutTitle ?? "";
    body = about.aboutBody ?? "";
    youtubeUrl = about.aboutYoutubeUrl ?? "";
    hasData = Boolean(title || body || youtubeUrl);
  } else {
    gqlError = "No ACF group 'about' found on this page.";
  }
} catch (e: any) {
  gqlError = e?.message || "WPGraphQL fetch failed";
}

function extractYouTubeId(url: string): string | null {
  if (!url) return null;
  const rules = [
    /youtu\.be\/([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/,
  ];
  for (const r of rules) {
    const m = url.match(r);
    if (m?.[1]) return m[1];
  }
  return null;
}

const videoId = extractYouTubeId(youtubeUrl || "");
const embedSrc = videoId ? `https://www.youtube-nocookie.com/embed/${videoId}` : "";
---

<section class="section-padding-sm pt-0 md:pt-6 bg-white">
  <div class="container-primary">
    <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 md:mb-6">
      {lang === "en" ? "About Bederly" : "เกี่ยวกับ Bederly"}
    </h2>

    <div class="about-container">
      <!-- กล่องข้อความ -->
      <div class="about-text-box">
        {hasData ? (
          <>
            {title && <h3 class="about-title" set:html={title}></h3>}
            {body && <p class="about-body">{body}</p>}
          </>
        ) : (
          <div class="text-white/90">
            {lang === "en" ? "About content not found." : "ยังไม่มีข้อมูลเกี่ยวกับบริษัท"}
          </div>
        )}
        {gqlError && <p class="mt-3 text-white/80 text-xs">GQL: {gqlError}</p>}
      </div>

      <!-- กล่องวิดีโอ -->
      <div class="about-video-box">
        {embedSrc ? (
          <div class="about-video-wrapper">
            <iframe
              class="w-full h-full"
              src={embedSrc}
              title="Bederly CEO Talk"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            />
          </div>
        ) : (
          <span class="text-gray-500">
            {lang === "en" ? "No video URL" : "ไม่มีวิดีโอ"}
          </span>
        )}
      </div>
    </div>
  </div>
</section>

<style>
/* ============================================
   DESKTOP (md and up): 2 คอลัมน์
   ============================================ */
.about-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2rem;
  align-items: center;
}
.about-text-box {
  background: #40B4E4;
  color: white;
  padding: 2rem;
  border-radius: 1rem;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 100%;
}
.about-video-box {
  border-radius: 1rem;
  background: #f3f4f6;
  box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
.about-title {
  font-size: 1.25rem;
  font-weight: 600;
  line-height: 1.4;
  margin-bottom: 1rem;
}
.about-body {
  color: rgba(255,255,255,0.95);
  line-height: 1.75;
  white-space: pre-line;
}
.about-video-wrapper {
  width: 100%;
  aspect-ratio: 16 / 9;
  border-radius: 0.75rem;
  overflow: hidden;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
@media (min-width: 768px) {
  .about-title {
    font-size: 1.5rem;
  }
}

/* ============================================
   MOBILE (single cyan card + refined typography)
   ============================================ */
@media (max-width: 767.98px) {
  .about-container {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    background: linear-gradient(180deg,#42B6E6 0%, #33AEE2 100%);
    border-radius: 16px;
    padding: 1.25rem 1rem 1.25rem;
    box-shadow: 0 18px 30px -12px rgba(0,0,0,.25);
  }
  .about-text-box {
    background: transparent;
    color: #fff;
    padding: 0;
    border-radius: 0;
    box-shadow: none;
  }
  .about-title {
    font-size: clamp(1.05rem, 2.4vw + .9rem, 1.55rem);
    line-height: 1.55;
    font-weight: 800;
    letter-spacing: .01em;
    margin: 0 0 .5rem 0;
    text-wrap: balance;
  }
  .about-body {
    color: rgba(255,255,255,.92);
    font-size: clamp(.95rem, 1.2vw + .8rem, 1.05rem);
    line-height: 1.85;
    letter-spacing: .005em;
    white-space: pre-line;
    text-wrap: pretty;
    margin: 0;
  }
  .about-video-box {
    background: transparent;
    padding: 0;
    border-radius: 12px;
    box-shadow: none;
  }
  .about-video-wrapper {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 20px -10px rgba(0,0,0,.35);
  }
  /* optional: เครื่องหมายคำพูด */
  .about-title::before {  margin-right: .15em; opacity: .9; }
  .about-title::after  {  margin-left: .1em;  opacity: .9; }
}
</style>
