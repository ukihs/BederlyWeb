---
import { wpQuery } from "../lib/wp";

export interface Props {
  lang: "th" | "en";
  /** หน้า WP ที่เก็บ ACF group: about */
  pageUriTH?: string;   // ex. "/"
  pageUriEN?: string;   // ex. "/en/welcome/"
}

const {
  lang,
  pageUriTH = "/",
  pageUriEN = "/en/welcome/",
} = Astro.props;

// ใช้ nodeByUri + inline fragment บน Page (เพราะ ACF group about ถูกแนบที่ post type: page)
const ABOUT_BY_URI = /* GraphQL */ `
  query AboutByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        id
        title
        uri
        language { code }
        about {
          aboutTitle
          aboutBody
          aboutYoutubeUrl
        }
      }
    }
  }
`;

// เลือก URI ตามภาษา
const uri = lang === "en" ? pageUriEN : pageUriTH;

let title = "";
let body = "";
let youtubeUrl = "";
let hasData = false;
let gqlError = "";

try {
  const res = await wpQuery<any>(ABOUT_BY_URI, { uri });
  const page = res?.nodeByUri;
  const about = page?.about;

  if (about) {
    title = about.aboutTitle ?? "";
    body = about.aboutBody ?? "";
    youtubeUrl = about.aboutYoutubeUrl ?? "";
    hasData = Boolean(title || body || youtubeUrl);
  } else {
    gqlError = "No ACF group 'about' found on this page.";
  }
} catch (e: any) {
  gqlError = e?.message || "WPGraphQL fetch failed";
}

/** ดึง YouTube videoId จาก URL รูปแบบต่าง ๆ */
function extractYouTubeId(url: string): string | null {
  if (!url) return null;
  const rules = [
    /youtu\.be\/([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/,
    /youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/,
  ];
  for (const r of rules) {
    const m = url.match(r);
    if (m?.[1]) return m[1];
  }
  return null;
}

const videoId = extractYouTubeId(youtubeUrl || "");
const embedSrc = videoId ? `https://www.youtube-nocookie.com/embed/${videoId}` : "";
---

<section class="section-padding bg-white">
  <div class="container-primary">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
      {lang === "en" ? "About Bederly" : "เกี่ยวกับ Bederly"}
    </h2>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- ข้อความ -->
      <div class="bg-[#40B4E4] text-white p-6 rounded-2xl shadow-lg">

        {hasData ? (
          <>
            {title && (
              <h3 class="text-xl md:text-2xl font-semibold leading-snug mb-4">
                {title}
              </h3>
            )}
            {body && (
              <p class="text-white/95 leading-relaxed whitespace-pre-line">
                {body}
              </p>
            )}
          </>
        ) : (
          <div class="text-white/90">
            {lang === "en" ? "About content not found." : "ยังไม่มีข้อมูลเกี่ยวกับบริษัท"}
          </div>
        )}

        {gqlError && (
          <p class="mt-3 text-white/80 text-xs">GQL: {gqlError}</p>
        )}
      </div>

      <!-- วิดีโอ -->
      <div class="rounded-2xl bg-gray-100 shadow-inner p-2 flex items-center justify-center">
        {embedSrc ? (
          <div class="w-full aspect-video rounded-xl overflow-hidden shadow">
            <iframe
              class="w-full h-full"
              src={embedSrc}
              title="Bederly video"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            />
          </div>
        ) : (
          <span class="text-gray-500">
            {lang === "en" ? "No video URL" : "ไม่มีวิดีโอ"}
          </span>
        )}
      </div>
    </div>
  </div>
</section>
