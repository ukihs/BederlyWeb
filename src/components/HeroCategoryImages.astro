---
// src/components/HeroCategoryImages.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  limit?: number;
  class?: string;
}

const { lang = "th", limit = 9, class: klass = "" } = Astro.props;

/* ---------- utilities ---------- */
function fix(src?: string) { return src ? rewriteWpUrl(src) : src; }
function toSrcSet(sizes?: Array<{ sourceUrl: string; width: number }>) {
  if (!sizes?.length) return undefined;
  return sizes
    .filter((s) => s?.sourceUrl && s?.width)
    .sort((a, b) => (Number(b.width) || 0) - (Number(a.width) || 0))
    .map((s) => `${fix(s.sourceUrl)} ${s.width}w`)
    .join(", ");
}
function bestUrl(img?: any): string | undefined {
  if (!img?.mediaDetails?.sizes) return fix(img?.sourceUrl);
  const sizes = img.mediaDetails.sizes;
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large"];
  for (const n of prefer) {
    const s = sizes.find((x: any) => x?.name === n);
    if (s?.sourceUrl && s?.width >= 800) return fix(s.sourceUrl);
  }
  const max = sizes
    .filter((s: any) => s?.sourceUrl && s?.width)
    .sort((a: any, b: any) => (b.width || 0) - (a.width || 0))[0];
  return fix(max?.sourceUrl || img?.sourceUrl);
}

/* ---------- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å slug ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î Hero ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤ ---------- */
const heroSlug = lang === "en" ? "hero-en" : "hero-th";

/* ---------- ‡∏î‡∏∂‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞ hero ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ categoryName (slug) ---------- */
const POSTS_BY_HERO_SLUG = /* GraphQL */ `
  query PostsByHeroSlug($first:Int!,$slug:String!){
    posts(
      first:$first
      where:{
        status:PUBLISH
        orderby:{field:DATE,order:ASC}
        categoryName:$slug
      }
    ){
      nodes{
        id
        title
        excerpt
        categories{ nodes{ name slug } }
        featuredImage{
          node{
            sourceUrl
            altText
            mediaDetails{ sizes{ name width height sourceUrl } }
          }
        }
      }
    }
  }
`;

let posts:any[] = [];
let debug:string|undefined;

try {
  const res = await wpQuery<any>(POSTS_BY_HERO_SLUG, { first: limit, slug: heroSlug });
  posts = (res?.posts?.nodes ?? []).filter((p:any)=>p?.featuredImage?.node?.sourceUrl);
} catch(e:any) {
  debug = e?.message ?? "WPGraphQL fetch failed";
}

/* ---------- Fallback (‡∏ñ‡πâ‡∏≤ hero ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á) ---------- */
const fallbackImg = `data:image/svg+xml;utf8,${encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 600'>
  <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#dbeafe'/><stop offset='1' stop-color='#cffafe'/></linearGradient></defs>
  <rect width='800' height='600' fill='url(#g)'/>
  <rect x='180' y='140' width='440' height='320' rx='22' fill='#60a5fa' opacity='.35'/>
</svg>`)}`
const fallback = [
  { title: lang==='en'?'Left-right tilt':'‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤', image: fallbackImg },
  { title: lang==='en'?'Height adjustment':'‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á', image: fallbackImg },
  { title: lang==='en'?'Leg section up/down':'‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á', image: fallbackImg },
  { title: lang==='en'?'Safety side rails':'‡∏£‡∏≤‡∏ß‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á', image: fallbackImg },
  { title: lang==='en'?'Electric remote control':'‡∏£‡∏µ‡πÇ‡∏°‡∏ó‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏•‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', image: fallbackImg },
  { title: lang==='en'?'Durable caster wheels':'‡∏•‡πâ‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô', image: fallbackImg },
];

const display = posts.length ? posts : fallback;

/* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏£ 3 ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏™‡∏°‡∏≠ */
const rem = display.length % 3;
const pad = rem === 0 ? 0 : 3 - rem;
const padded = pad ? display.concat(display.slice(0, pad)) : display;
const grouped:any[] = [];
for (let i = 0; i < padded.length; i += 3) grouped.push(padded.slice(i, i + 3));
---

{grouped.length>0 && (
  <section data-slider class={`relative ${klass}`}>
    <div class="relative pb-10">
      <div id="hero-slider" class="overflow-hidden rounded-2xl bg-white shadow-2xl">
        <div id="slides-container" class="flex transition-transform duration-500 ease-in-out" style="transform: translateX(0%)">
          {grouped.map((g,gi)=>(
            <div class="w-full flex-shrink-0">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 items-stretch">
                {g.map((it,ii)=>{
                  const img = (it as any).featuredImage?.node;
                  if (img) {
                    const src = bestUrl(img); const srcset = toSrcSet(img.mediaDetails?.sizes);
                    return (
                      <div class="relative bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="relative aspect-[4/3]">
                          <img src={src} srcset={srcset} sizes="(max-width:768px) 100vw, 33vw"
                               alt={img.altText || (it as any).title}
                               loading={gi===0&&ii<3?"eager":"lazy"} decoding="async"
                               class="absolute inset-0 w-full h-full object-cover"/>
                        </div>
                        <div class="pointer-events-none absolute left-1/2 -translate-x-1/2 bottom-3">
                          <span class="pointer-events-auto inline-block rounded-full bg-sky-500 text-white text-sm md:text-base font-medium px-6 md:px-8 py-2 shadow-md">
                            <span set:html={(it as any).title}/>
                          </span>
                        </div>
                      </div>
                    );
                  }
                  return (
                    <div class="relative bg-white rounded-2xl shadow-lg overflow-hidden">
                      <div class="relative aspect-[4/3]">
                        <img src={(it as any).image} alt={(it as any).title} class="absolute inset-0 w-full h-full object-cover"/>
                      </div>
                      <div class="pointer-events-none absolute left-1/2 -translate-x-1/2 bottom-3">
                        <span class="pointer-events-auto inline-block rounded-full bg-sky-500 text-white text-sm md:text-base font-medium px-6 md:px-8 py-2 shadow-md">
                          {(it as any).title}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      </div>

      {grouped.length>1 && (
        <>
          <button id="prev-slide" aria-label="Previous"
            class="absolute left-2 md:left-3 top-1/2 -translate-y-1/2 w-10 h-10 md:w-11 md:h-11 bg-white rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all grid place-items-center">
            <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <button id="next-slide" aria-label="Next"
            class="absolute right-2 md:right-3 top-1/2 -translate-y-1/2 w-10 h-10 md:w-11 md:h-11 bg-white rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all grid place-items-center">
            <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </button>
        </>
      )}

      {grouped.length>1 && (
        <div id="dots-container" class="absolute -bottom-1 left-1/2 -translate-x-1/2 flex gap-2">
          {grouped.map((_,i)=>(
            <button class={`w-2.5 h-2.5 rounded-full ${i===0?"bg-sky-500":"bg-gray-300 hover:bg-gray-400"} transition-all`} data-slide={i}/>
          ))}
        </div>
      )}
    </div>

    {import.meta.env.DEV && (
      <div class="mt-4 p-4 bg-white/80 text-gray-800 text-xs rounded-lg shadow border border-gray-200">
        <p><strong>üñºÔ∏è Slider Debug</strong></p>
        <p>Hero slug used: <span class="font-mono bg-gray-100 px-2 py-0.5 rounded">{heroSlug}</span></p>
        {debug && <p class="text-red-600">Error: {debug}</p>}
        <p>Display Posts: {display.length} | Padded: {padded.length} | Slides: {grouped.length}</p>
      </div>
    )}
  </section>
)}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const slidesContainer = document.getElementById('slides-container');
  const prevButton = document.getElementById('prev-slide');
  const nextButton = document.getElementById('next-slide');
  const dotsContainer = document.getElementById('dots-container');
  if (!slidesContainer) return;

  const slides = slidesContainer.children;
  const totalSlides = slides.length;
  let current = 0, timer; const delay = 6000;

  const setDots = () => {
    if (!dotsContainer) return;
    dotsContainer.querySelectorAll('button').forEach((d, i) => {
      d.className = i===current
        ? 'w-2.5 h-2.5 rounded-full bg-sky-500 transition-all'
        : 'w-2.5 h-2.5 rounded-full bg-gray-300 hover:bg-gray-400 transition-all';
    });
  };
  const go = (i:number) => { current = (i+totalSlides)%totalSlides; slidesContainer.style.transform = `translateX(${-current*100}%)`; setDots(); };
  const next = () => go(current+1);
  const prev = () => go(current-1);
  const start = () => { if (totalSlides>1) timer = setInterval(next, delay); };
  const stop = () => clearInterval(timer);

  nextButton?.addEventListener('click', () => { next(); stop(); start(); });
  prevButton?.addEventListener('click', () => { prev(); stop(); start(); });
  dotsContainer?.querySelectorAll('button').forEach((d,i)=> d.addEventListener('click',()=>{ go(i); stop(); start(); }));

  // touch
  let sx=0, dragging=false;
  slidesContainer.addEventListener('touchstart', e => { sx=e.touches[0].clientX; dragging=true; stop(); });
  slidesContainer.addEventListener('touchmove', e => { if(!dragging) return; e.preventDefault(); });
  slidesContainer.addEventListener('touchend', e => {
    if(!dragging) return;
    const dx = sx - e.changedTouches[0].clientX;
    if (Math.abs(dx) > 50) (dx>0?next():prev());
    dragging=false; start();
  });

  // keyboard
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') { prev(); stop(); start(); }
    else if (e.key === 'ArrowRight') { next(); stop(); start(); }
  });

  start(); setDots();
});
</script>

<style>
[data-slider]{ position:relative; }
#slides-container{ transition: transform .5s cubic-bezier(.4,0,.2,1); }
button:focus-visible{ outline:2px solid #3b82f6; outline-offset:2px; }
</style>
