---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  limit?: number;
  class?: string;
}

const {
  lang = "th",
  limit = 8,
  class: klass = "",
} = Astro.props;

const innovationSlug = lang === "en" ? "innovation-en" : "innovation-th";

const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($first: Int!, $category: String!, $language: LanguageCodeFilterEnum) {
    posts(
      first: $first
      where: {
        categoryName: $category
        orderby: { field: DATE, order: ASC }
        status: PUBLISH
        language: $language
      }
    ) {
      nodes {
        id
        title
        uri
        slug
        excerpt
        featuredImage {
          node {
            id
            altText
            sourceUrl
            mediaDetails {
              width
              height
              sizes { name width height sourceUrl }
            }
          }
        }
      }
    }
  }
`;

const languageFilter = (lang.toUpperCase() as "TH" | "EN");

/* helpers */
function normalize(img?: any) { return img?.node ? img.node : img; }
function pickImageUrl(img?: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large", "medium"];
  for (const key of prefer) {
    const s = sizes.find((x: any) => x?.name === key && x?.sourceUrl);
    if (s?.sourceUrl) return rewriteWpUrl(s.sourceUrl);
  }
  return n?.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

let posts: any[] = [];
let errorMsg = "";

try {
  const res = await wpQuery<any>(POSTS_BY_CATEGORY, {
    first: limit,
    category: innovationSlug,
    language: languageFilter,
  });
  posts = (res?.posts?.nodes ?? []).filter((p: any) => !!p?.featuredImage?.node?.sourceUrl);
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}
---

<section class={`innov-section ${klass}`}>
  <!-- Header -->
  <div class="mb-6 md:mb-8">
    <h2 class="text-3xl md:text-5xl font-bold tracking-tight text-gray-900">
      {lang === "en" ? <>Our Other Innovations</> : <>นวัตกรรมอื่นๆ ของเรา</>}
    </h2>
    <p class="mt-3 text-gray-900">
      {lang === "en"
        ? <>Bederly is an Integrated Platform Offering <br /> Interconnected Proprietary Products​</>
        : <>เป็นแพลตฟอร์มที่เชื่อมต่อผลิตภัณฑ์ต่างๆ <br /> เข้าด้วยกันอย่างครบวงจร​</>}
    </p>
  </div>

  {posts.length > 0 ? (
    <div class="innov-grid grid gap-6 md:gap-8 lg:grid-cols-2">
      {posts.map((p) => {
        const img = p.featuredImage?.node;
        const src = pickImageUrl(img);

        return (
          <article class="innov-card">
            <div class="innov-inner">
              {/* LEFT: Text */}
              <div class="innov-copy">
                <h3 class="innov-title" set:html={p.title} />
                {p.excerpt && <div class="innov-desc prose prose-slate" set:html={p.excerpt} />}
              </div>

              {/* RIGHT: Image */}
              {src && (
                <div class="innov-media">
                  <img
                    src={src}
                    alt={img?.altText || p.title}
                    class="innov-img"
                    loading="lazy"
                    decoding="async"
                    draggable="false"
                  />
                </div>
              )}
            </div>
          </article>
        );
      })}
    </div>
  ) : (
    <div class="rounded-2xl bg-white/60 p-8 text-center text-gray-500 shadow">
      {errorMsg
        ? (lang === "en" ? "Cannot fetch innovation posts." : "ไม่สามารถดึงโพสต์นวัตกรรมได้") + ` (${errorMsg})`
        : (lang === "en" ? "No innovation posts found." : "ไม่พบนวัตกรรม")}
    </div>
  )}
</section>

<style>
  .prose :where(p){
    margin: .45rem 0;
    line-height: 1.6;
    color: rgb(75 85 99);
  }

  :root{
    --innov-radius: 24px;
    --innov-pad-x: 28px;
    --innov-pad-y: 28px;
    --innov-shadow: 0 10px 30px rgba(0,0,0,.08);
    --innov-border: 1px solid rgba(0,0,0,.06);
    --title-size: clamp(22px, 2.4vw, 32px);
    --title-color: #111827;
    --gap-x: clamp(20px, 3vw, 40px);
    --img-max-w: clamp(260px, 36vw, 460px);
    --img-max-h: clamp(200px, 34vw, 360px);
  }

  .innov-section{ margin-top: 0 !important; padding-top: 0 !important; }
  .innov-grid{ margin-top: 1.25rem !important; }

  /* ===== Card: STATIC (no hover) ===== */
  .innov-card{
    position: relative;
    border-radius: var(--innov-radius);
    background: #fff;
    border: var(--innov-border);
    box-shadow: var(--innov-shadow);
    overflow: hidden;
    /* ปิดทุกการแอนิเมชัน/เอฟเฟกต์ */
    transform: none !important;
    transition: none !important;
  }
  .innov-card::after{ content: none !important; }       /* ไม่ให้มี ring ตอน hover */
  .innov-card:hover{                                     /* กัน hover ใดๆ */
    transform: none !important;
    box-shadow: var(--innov-shadow) !important;
  }

  .innov-inner{
    display: grid;
    grid-template-columns: 1.15fr 1fr;
    gap: var(--gap-x);
    padding: var(--innov-pad-y) var(--innov-pad-x);
    align-items: center;
  }

  .innov-copy{ text-align: left; }

  .innov-title{
    font-weight: 800;
    font-size: var(--title-size);
    line-height: 1.25;
    color: var(--title-color);
    margin: 0 0 10px 0;
  }

  .innov-desc p{
    white-space: pre-line;
    line-height: 1.7;
    color: #374151;
    font-size: clamp(15px, 1.6vw, 17px);
    margin-top: 6px;
  }

  .innov-media{
    position: relative;
    display: flex; align-items: center; justify-content: center;
    min-height: 160px;
  }

  .innov-img{
    position: relative; z-index: 1;
    max-width: var(--img-max-w); max-height: var(--img-max-h);
    width: auto; height: auto; object-fit: contain;
    /* ปิดการซูม/เฟดตอน hover */
    transition: none !important;
    transform: none !important;
    filter: drop-shadow(0 8px 20px rgba(0,0,0,.12));
    border-radius: 14px;
    mix-blend-mode: multiply;
    opacity: .97;
  }

  /* ยกเลิก selector ที่เคยทำงานตอน hover ของกลุ่ม */
  .group:hover .innov-img{ transform: none !important; filter: drop-shadow(0 8px 20px rgba(0,0,0,.12)) !important; opacity: .97 !important; }

  @media (min-width: 1024px){
    .innov-inner{ align-items: start !important; }
    .innov-copy{
      align-self: start !important;
      justify-self: start !important;
      margin-top: 0 !important;
      padding-top: 8px;
      text-align: left;
    }
    .innov-media{
      align-self: start !important;
      justify-content: flex-end;
      min-height: 0;
    }
  }

  .innov-link{ position:absolute; inset:0; } /* ยังคลิกได้ทั้งใบ */

  @media (max-width: 1023.98px){
    .innov-inner{ grid-template-columns: 1fr; gap: 18px; }
    .innov-media{ justify-content: flex-start; }
    .innov-img{ max-width: min(92%, 520px); max-height: 320px; }
  }
</style>
