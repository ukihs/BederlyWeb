---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  limit?: number;          // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
  class?: string;          // class ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏µ‡πà wrapper
}

const {
  lang = "th",
  limit = 8,
  class: klass = "",
} = Astro.props;

// map slug ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤
const innovationSlug = lang === "en" ? "innovation-en" : "innovation-th";

// ===== GraphQL =====
const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($first: Int!, $category: String!, $language: LanguageCodeFilterEnum) {
    posts(
      first: $first
      where: {
        categoryName: $category
        orderby: { field: DATE, order: ASC }
        status: PUBLISH
        language: $language
      }
    ) {
      nodes {
        id
        title
        uri
        slug
        excerpt
        featuredImage {
          node {
            id
            altText
            sourceUrl
            mediaDetails {
              width
              height
              sizes { name width height sourceUrl }
            }
          }
        }
      }
    }
  }
`;

const languageFilter = (lang.toUpperCase() as "TH" | "EN");

// ===== helpers =====
function normalize(img?: any) {
  return img?.node ? img.node : img;
}
function pickImageUrl(img?: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large", "medium"];
  for (const key of prefer) {
    const s = sizes.find((x: any) => x?.name === key && x?.sourceUrl);
    if (s?.sourceUrl) return rewriteWpUrl(s.sourceUrl);
  }
  return n?.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

let posts: any[] = [];
let errorMsg = "";

try {
  const res = await wpQuery<any>(POSTS_BY_CATEGORY, {
    first: limit,
    category: innovationSlug,
    language: languageFilter,
  });
  posts = (res?.posts?.nodes ?? []).filter((p: any) => !!p?.featuredImage?.node?.sourceUrl);
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}
---


<section class={`py-16 md:py-24 ${klass}`}>
  <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ô‡∏™‡∏∏‡∏î (hardcode) -->
  <div class="container-primary mb-10 md:mb-14">
    <h2 class="text-3xl md:text-5xl font-extrabold tracking-tight text-gray-900">
      {lang === "en" ? "Our Other Innovations" : "‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤"}
    </h2>
    <p class="mt-3 text-gray-600 max-w-2xl">
      {lang === "en"
        ? "Bederly is an Integrated Platform Offering Interconnected Proprietary Products‚Äã"
        : "‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£"}
    </p>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå -->
  <div class="container-primary">
    {posts.length > 0 ? (
      <div class="grid gap-6 md:gap-8 lg:grid-cols-2">
        {posts.map((p) => {
          const img = p.featuredImage?.node;
          const src = pickImageUrl(img);

          return (
            <article class="group relative overflow-hidden rounded-3xl bg-white shadow-lg ring-1 ring-black/5">
              <div class="grid grid-cols-1 md:grid-cols-2">
                <!-- ‡∏†‡∏≤‡∏û -->
                <div class="relative p-6 md:p-8">
                  <div class="aspect-[4/3] w-full overflow-hidden rounded-2xl bg-gradient-to-br from-sky-50 to-cyan-50">
                    {src ? (
                      <img
                        src={src}
                        alt={img?.altText || p.title}
                        class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-[1.03]"
                        loading="lazy"
                        decoding="async"
                      />
                    ) : (
                      <div class="flex h-full w-full items-center justify-center text-sky-400/60">
                        <svg class="h-14 w-14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-8 10V7m0 0L9 10m3-3l3 3"/>
                        </svg>
                      </div>
                    )}
                  </div>
                </div>

                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
                <div class="p-6 md:p-8 flex flex-col">
                  <h3 class="text-2xl font-bold text-gray-900 mb-3 leading-tight" set:html={p.title} />
                  {p.excerpt && (
                    <div class="prose prose-slate max-w-none text-gray-600 prose-p:my-0"
                         set:html={p.excerpt} />
                  )}

                  <div class="mt-auto pt-6">
                    <a href={p.uri || `/${lang}/${p.slug}`}
                       class="inline-flex items-center gap-2 rounded-xl bg-sky-600 px-5 py-2.5 text-white shadow hover:bg-sky-700 transition">
                      {lang === "en" ? "Learn more" : "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <div class="rounded-2xl bg-white/60 p-8 text-center text-gray-500 shadow">
        {errorMsg
          ? (lang === "en" ? "Cannot fetch innovation posts." : "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ") + ` (${errorMsg})`
          : (lang === "en" ? "No innovation posts found." : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°")}
      </div>
    )}
  </div>

  {/* Debug (DEV only) */}
  {import.meta.env.DEV && (
    <div class="container-primary mt-6">
      <details class="rounded-xl bg-white p-4 text-sm text-gray-700 shadow">
        <summary class="cursor-pointer select-none">üîé Innovation Debug</summary>
        <div class="mt-2 space-y-1">
          <div>Lang: <code class="bg-gray-100 px-1 rounded">{lang}</code></div>
          <div>Category: <code class="bg-gray-100 px-1 rounded">{innovationSlug}</code></div>
          <div>Count: {posts.length}</div>
          {errorMsg && <div class="text-red-600">Error: {errorMsg}</div>}
        </div>
      </details>
    </div>
  )}
</section>
