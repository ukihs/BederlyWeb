---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  limit?: number;
  class?: string;
}

const {
  lang = "th",
  limit = 8,
  class: klass = "",
} = Astro.props;

const innovationSlug = lang === "en" ? "innovation-en" : "innovation-th";

const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($first: Int!, $category: String!, $language: LanguageCodeFilterEnum) {
    posts(
      first: $first
      where: {
        categoryName: $category
        orderby: { field: DATE, order: ASC }
        status: PUBLISH
        language: $language
      }
    ) {
      nodes {
        id
        title
        uri
        slug
        excerpt
        featuredImage {
          node {
            id
            altText
            sourceUrl
            mediaDetails {
              width
              height
              sizes { name width height sourceUrl }
            }
          }
        }
      }
    }
  }
`;

const languageFilter = (lang.toUpperCase() as "TH" | "EN");

function normalize(img?: any) {
  return img?.node ? img.node : img;
}
function pickImageUrl(img?: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large", "medium"];
  for (const key of prefer) {
    const s = sizes.find((x: any) => x?.name === key && x?.sourceUrl);
    if (s?.sourceUrl) return rewriteWpUrl(s.sourceUrl);
  }
  return n?.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

let posts: any[] = [];
let errorMsg = "";

try {
  const res = await wpQuery<any>(POSTS_BY_CATEGORY, {
    first: limit,
    category: innovationSlug,
    language: languageFilter,
  });
  posts = (res?.posts?.nodes ?? []).filter((p: any) => !!p?.featuredImage?.node?.sourceUrl);
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}
---

<section class={klass}>
  <!-- Header Section -->
  <div class="mb-10 md:mb-14">
    <h2 class="text-3xl md:text-5xl font-extrabold tracking-tight text-gray-900">
      {lang === "en" ? <>Our Other <br /> Innovations</> : <>นวัตกรรมอื่น ๆ <br /> ของเรา</>}
    </h2>
    <p class="mt-3 text-gray-600">
      {lang === "en"
        ? <>Bederly is an Integrated Platform Offering <br /> Interconnected Proprietary Products​</>
        : <>เป็นแพลตฟอร์มที่เชื่อมต่อผลิตภัณฑ์ต่างๆ <br /> เข้าด้วยกันอย่างครบวงจร​</>}
    </p>
  </div>

  {posts.length > 0 ? (
    <div class="grid gap-6 md:gap-8 lg:grid-cols-2">
      {posts.map((p) => {
        const img = p.featuredImage?.node;
        const src = pickImageUrl(img);

        return (
          <article
            class="group relative overflow-hidden rounded-[32px] bg-gradient-to-b from-cyan-50/60 via-white/95 to-blue-50/40
                   shadow-xl transform-gpu transition-all duration-300
                   hover:scale-[1.01] hover:shadow-2xl border border-cyan-100/30"
          >
            {/* Header section with title */}
            <div class="relative z-10 text-center p-6 md:p-8">
              <h3 class="text-2xl md:text-3xl font-bold text-gray-900 leading-tight" set:html={p.title}></h3>
              {p.excerpt && (
                <div class="prose prose-slate mx-auto text-gray-600 mt-2 text-sm md:text-base prose-p:my-0" set:html={p.excerpt}></div>
              )}
            </div>

            {/* Image section - seamless with background */}
            {src && (
              <div class="relative z-0 px-4 md:px-6 pb-6 md:pb-8">
                <div class="mx-auto w-full">
                  {/* Direct image without white container - blend with card background */}
                  <div class="relative h-[280px] sm:h-[320px] md:h-[360px] lg:h-[400px] 
                              flex items-center justify-center">
                    <img
                      src={src}
                      alt={img?.altText || p.title}
                      class="max-w-[85%] max-h-[85%] w-auto h-auto object-contain
                             transition-all duration-500 ease-out group-hover:scale-[1.05]
                             mix-blend-multiply opacity-95 group-hover:opacity-100"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                </div>
              </div>
            )}

            <div class="pointer-events-none absolute inset-0 rounded-[32px] ring-1 ring-transparent group-hover:ring-cyan-300/70 transition-colors duration-500"></div>

            <a href={p.uri || `/${lang}/${p.slug}`} class="absolute inset-0" aria-label="Open innovation"></a>
          </article>
        );
      })}
    </div>
  ) : (
    <div class="rounded-2xl bg-white/60 p-8 text-center text-gray-500 shadow">
      {errorMsg
        ? (lang === "en" ? "Cannot fetch innovation posts." : "ไม่สามารถดึงโพสต์นวัตกรรมได้") + ` (${errorMsg})`
        : (lang === "en" ? "No innovation posts found." : "ไม่พบนวัตกรรม")}
    </div>
  )}
</section>

<style>
  /* Clean card styling with seamless background */
  article {
    background: linear-gradient(
      135deg,
      rgba(236, 254, 255, 0.6),
      rgba(255, 255, 255, 0.95),
      rgba(219, 234, 254, 0.4)
    );
    position: relative;
    isolation: isolate;
  }

  /* Smooth transitions for all interactive elements */
  img, article {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Mix blend mode for seamless integration */
  .mix-blend-multiply {
    mix-blend-mode: multiply;
  }

  /* Hover effects */
  .group:hover img {
    filter: brightness(1.02) saturate(1.1);
  }

  /* Text content styling */
  .prose p {
    line-height: 1.6;
    color: rgb(75 85 99);
  }

  /* Card hover animation */
  article:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 
      0 30px 60px -15px rgb(0 0 0 / 0.15),
      0 0 0 1px rgb(6 182 212 / 0.1);
  }

  /* Ensure good text contrast */
  h3 {
    color: rgb(17 24 39);
  }

  /* Mobile responsive */
  @media (max-width: 640px) {
    article {
      padding-bottom: 1.5rem;
    }
  }

  /* Subtle animation on load */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  article {
    animation: fadeInUp 0.6s ease-out forwards;
    animation-fill-mode: both;
  }

  article:nth-child(2) {
    animation-delay: 0.1s;
  }

  /* Subtle gradient overlay for depth */
  article::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
      circle at 50% 0%,
      transparent 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0.3) 100%
    );
    pointer-events: none;
    z-index: 1;
  }

  /* Image area subtle gradient */
  .relative.z-0::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
      circle at center,
      transparent 40%,
      rgba(255, 255, 255, 0.4) 100%
    );
    pointer-events: none;
  }
</style>