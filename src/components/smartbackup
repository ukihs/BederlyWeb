---
// src/components/SmartBedSection.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
}

const { lang = "th" } = Astro.props;
const languageFilter = lang.toUpperCase() as "TH" | "EN";

const uriCandidates = lang === "en"
  ? ["/", "/home/", "/home", "/en/", "/en"]
  : ["/", "/th/", "/th", "/หน้าแรก/", "/หน้าแรก"];

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined {
  return img?.node ? img.node : img ?? undefined;
}

function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

const SMARTBED_LANGUAGE_QUERY = /* GraphQL */ `
  query SmartBedByLanguage($language: LanguageCodeFilterEnum!) {
    pages(first: 10, where: { language: $language, status: PUBLISH }) {
      nodes {
        id
        title
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails { width height sizes { name width height sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

const SMARTBED_URI_QUERY = /* GraphQL */ `
  query SmartBedByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        id
        title
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails { width height sizes { name width height sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

let smartbedTitle = "";
let smartbedSub = "";
let smartbedImageUrl = "";
let foundSmartbedData = false;

try {
  const languageData = await wpQuery<any>(SMARTBED_LANGUAGE_QUERY, { language: languageFilter });
  const pages = languageData?.pages?.nodes || [];
  const target = pages.find((p: any) => p.smartbed && (p.smartbed.smartbedtitle || p.smartbed.smartbedimage));
  if (target?.smartbed) {
    smartbedTitle = target.smartbed?.smartbedtitle || smartbedTitle;
    smartbedSub = target.smartbed?.smartbedsub || smartbedSub;
    smartbedImageUrl = pickImageUrl(target.smartbed?.smartbedimage) || smartbedImageUrl;
    if (smartbedTitle || smartbedSub || smartbedImageUrl) foundSmartbedData = true;
  }
} catch (e) {
  console.warn("[SMARTBED] Language query failed:", e);
}

if (!foundSmartbedData) {
  for (const uri of uriCandidates) {
    try {
      const data = await wpQuery<any>(SMARTBED_URI_QUERY, { uri });
      const sb = data?.nodeByUri?.smartbed;
      if (!sb) continue;
      smartbedTitle = sb?.smartbedtitle || smartbedTitle;
      smartbedSub = sb?.smartbedsub || smartbedSub;
      smartbedImageUrl = pickImageUrl(sb?.smartbedimage) || smartbedImageUrl;
      if (smartbedTitle || smartbedSub || smartbedImageUrl) { foundSmartbedData = true; break; }
    } catch {}
  }
}
---

<section class="bg-white overflow-x-clip smartbed-section">
  <div class="container-primary smartbed-container">
    <div class="relative overflow-hidden shadow-2xl md:min-h-[680px] lg:min-h-[760px] smartbed-card">
      
      <!-- ===== Desktop: Background Image (unchanged) ===== -->
      {smartbedImageUrl ? (
        <img
          src={smartbedImageUrl}
          alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          class="absolute inset-0 w-full h-full object-cover desktop-only desktop-bg"
          loading="lazy"
        />
      ) : (
        <div class="absolute inset-0 bg-blue-200 desktop-only" />
      )}

      <!-- ===== Desktop Content (unchanged) ===== -->
      <div class="relative z-10 grid lg:grid-cols-2 items-center gap-8 p-10 md:p-16 lg:p-20 desktop-only">
        <div class="max-w-xl lg:max-w-2xl text-white">
          <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
            {lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          </h2>
          <h3 class="text-xl md:text-2xl lg:text-3xl font-medium mb-8">
            {smartbedTitle ||
              (lang === "en"
                ? <>
                    <span class="font-light"> Innovative Care </span><br />
                    <span class="font-light">for the Ones Your loved ones </span>
                  </>
                : <>
                    <span class="font-light"> นวัตกรรมดูแลสุขภาพ </span><br />
                    <span class="font-light">ของคนที่คุณรัก</span>
                  </>)}
          </h3>
          <p class="text-base md:text-lg/8 lg:text-xl/9 mb-10 opacity-95">
            {smartbedSub ||
              (lang === "en"
                ? "The smart bed is an electric bed that distributes pressure and supports caregivers in repositioning patients. With IoT integration, it can be controlled remotely via smartphone. Embedded technology enhances its intelligence, enabling seamless connection and interaction with other devices."
                : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย ด้วยการผสาน IOT สามารถควบคุมระยะไกลผ่านสมาร์ทโฟน เทคโนโลยีฝังตัวช่วยเพิ่มความอัจฉริยะ ทำให้เชื่อมต่อและโต้ตอบกับอุปกรณ์อื่นได้อย่างราบรื่น")}
          </p>

          <a
            href="#footer"
            class="group inline-flex items-center gap-3 px-8 py-4 rounded-full
                   bg-white text-[#00D2E6] font-semibold text-lg shadow-md
                   transition-all duration-300 hover:shadow-lg"
          >
            {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 transition-transform duration-300 group-hover:translate-x-1"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="8">
              <path strokeLinecap="round" strokeLinejoin="round" d="M3 12h16" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M13 6l6 6-6 6" />
            </svg>
          </a>
        </div>
        <div class="hidden lg:block"></div>
      </div>

      <!-- ===== Mobile Content ===== -->
      <div class="mobile-only">
        <div class="mwrap">
          {smartbedImageUrl && (
            <img src={smartbedImageUrl} alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"} class="m-bg" loading="lazy" />
          )}
          <div class="m-dim" aria-hidden="true"></div>

          <div class="m-copy">
            <h2 class="m-title">{lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}</h2>
            <h3 class="m-sub">
              {smartbedTitle ||
                (lang === "en"
                  ? <>Innovative Care<br/>for the Ones Your loved ones</>
                  : <>นวัตกรรมดูแลสุขภาพ<br/><span class="thin">ของคนที่คุณรัก</span></>)}
            </h3>

            <p class="m-desc">
              {smartbedSub ||
                (lang === "en"
                  ? "The smart bed is an electric bed that distributes pressure and supports caregivers in repositioning patients. With IoT integration, it can be controlled remotely via smartphone. Embedded technology enhances its intelligence, enabling seamless connection and interaction with other devices."
                  : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย ด้วยการผสาน IOT สามารถควบคุมระยะไกลผ่านสมาร์ทโฟน")}
            </p>

            <a href="#footer" class="m-cta">
              {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
              <svg class="m-cta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .mobile-only { display: none; }

  /* ===== Desktop only (unchanged) ===== */
  @media (min-width: 1024px) {
    .smartbed-card {
      --sb-crop-bottom: 160px;
      margin-bottom: calc(-1 * var(--sb-crop-bottom));
      border-radius: 24px;
      overflow: hidden;
    }
    .smartbed-card > img.desktop-bg {
      object-fit: cover;
      object-position: center;
      clip-path: inset(0 0 var(--sb-crop-bottom) 0);
      will-change: clip-path;
    }
    .smartbed-container { padding-bottom: 0 !important; }
    .smartbed-section + * { margin-top: 0 !important; }
  }

  /* ===== MOBILE base ===== */
  @media (max-width: 1023.98px) {
    .desktop-only { display: none !important; }
    .mobile-only  { display: block !important; }

    .mwrap{
      position: relative;
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border-radius: 28px;
      overflow: hidden;
      margin-top: clamp(10px, 3vw, 18px);
      margin-bottom: clamp(16px, 4vw, 24px);
      min-height: clamp(520px, 140vw, 620px);
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
      isolation: isolate;
    }

    .m-bg{
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      object-position: 70% center;
      transform: scale(1.35);
      z-index: 0;
    }

    .m-dim{
      position: absolute; inset: 0 auto 0 0;
      width: clamp(58%, 72vw, 78%);
      z-index: 1; pointer-events: none;
      background:
        radial-gradient(120% 120% at 15% 15%, rgba(0,0,0,.46) 0%, rgba(0,0,0,.32) 45%, rgba(0,0,0,.12) 70%, rgba(0,0,0,0) 100%),
        linear-gradient(90deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,.38) 55%, rgba(0,0,0,.12) 80%, rgba(0,0,0,0) 100%);
    }

    .m-copy{
      position: relative; z-index: 2; color: #fff;
      padding: 24px 20px 26px;
      max-width: 76%;
      text-shadow: 0 1px 2px rgba(0,0,0,.4);
    }
    .m-title{
      font-weight: 800;
      font-size: 26px;
      line-height: 1.2;
      margin-bottom: 10px;
    }
    .m-sub{
      font-weight: 600;
      font-size: 16px;
      line-height: 1.38;
      margin-bottom: 14px;
    }
    .m-sub .thin{ font-weight: 300; }
    .m-desc{
      font-size: 14px;
      line-height: 1.55;
      margin-bottom: 18px;
    }

    .m-cta{
      display: inline-flex; align-items: center; gap: 10px;
      background: #fff; color: #00D2E6;
      padding: 12px 18px; border-radius: 999px; font-weight: 700;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .m-cta:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(0,0,0,.18); }
    .m-cta-icon{ width: 18px; height: 18px; }
  }

  /* ===== Desktop crop (unchanged) ===== */
  @media (min-width:1024px){
    .smartbed-section{ --cut: 200px; }
    .smartbed-card{ clip-path: inset(0 0 var(--cut) 0); transform: translateZ(0); }
    .smartbed-section{ margin-bottom: calc(-1 * var(--cut)); }
    .smartbed-section + *{ margin-top: 0 !important; padding-top: 0 !important; }
  }

  /* ===== MOBILE OVERRIDES: ดึงขึ้นให้ชิดจริง ๆ ===== */
  @media (max-width: 1023.98px) {
    /* รีเซ็ตทุกแหล่ง spacing ของ section นี้ */
    .smartbed-section {
      padding-top: 0 !important;
      margin-top: 0 !important;
      display: flow-root; /* กัน margin-collapsing */
      /* ดึงขึ้นด้วย margin ลบแบบยืดหยุ่น (ครอบทุกเคสช่องว่างใหญ่) */
      --pull-mobile: clamp(120px, 18vw, 280px);
      margin-top: calc(-1 * var(--pull-mobile)) !important;
    }
    .smartbed-container {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    /* เอา margin-top ของ hero mobile card ออกให้สุด */
    .mobile-only .mwrap { margin-top: 0 !important; }

    /* กันเคสที่ element ถัดไปดันลงอีก */
    .smartbed-section + * { margin-top: 0 !important; padding-top: 0 !important; }
  }
</style>
