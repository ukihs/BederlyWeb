---
// src/components/DownloadCTA_Band.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  class?: string;
}

const { lang, class: sectionClass = "" } = Astro.props;
const categorySlug = lang === "en" ? "download-en" : "download-th";

const DOWNLOAD_QUERY = /* GraphQL */ `
  query DownloadByCategory($slug: String!) {
    posts(
      first: 1
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        excerpt
        content
        featuredImage {
          node {
            altText
            sourceUrl
            mediaDetails { sizes { name sourceUrl width height } }
          }
        }
      }
    }
  }
`;

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined { return img?.node ? img.node : img ?? undefined; }
function pickImageUrl(img: any): string | undefined {
  const n = normalize(img); if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}
function htmlOrBlank(s?: string) {
  const t = (s ?? "").trim();
  return t && t.replace(/(<[^>]*>)|(&nbsp;)|\s+/g, "") !== "" ? t : "";
}

let post: any | undefined;
try {
  const res = await wpQuery<any>(DOWNLOAD_QUERY, { slug: categorySlug });
  post = res?.posts?.nodes?.[0];
} catch {}

const titleText =
  (post?.title as string) ||
  (lang === "en"
    ? "Download the Bederly PHR App to track your health"
    : "ดาวน์โหลดแอป Bederly PHR เพื่อติดตามสุขภาพของคุณ");

const descHtml = htmlOrBlank(post?.excerpt) || htmlOrBlank(post?.content) || "";
const imgUrl = pickImageUrl(post?.featuredImage);
const imgAlt = normalize(post?.featuredImage)?.altText || titleText;

const googlePlay = "https://play.google.com/store/apps/details?id=com.bederly.phr";
const appStore   = "https://apps.apple.com/th/app/id0000000000";
---

<section class={`relative isolate py-14 md:py-16 lg:py-20 ${sectionClass}`.trim()}>
  <!-- แถบพื้นหลังฟ้าไล่เฉด: สี่เหลี่ยมคม (ไม่โค้ง) และสูงขึ้น -->
  <div
    class="pointer-events-none absolute inset-x-0 top-1/2 -translate-y-1/2 z-0
           h-[300px] sm:h-[340px] lg:h-[380px]
           bg-gradient-to-r from-sky-600 via-sky-500 to-cyan-400">
  </div>

  <div class="container-primary relative z-10">
    <div class="grid md:grid-cols-2 gap-10 lg:gap-16 items-center">
      <!-- ซ้าย: รูป (ขยายสูงขึ้น) -->
      <div class="order-1 md:order-none">
        {imgUrl ? (
          <div class="inline-block p-3">
            <img
              src={imgUrl}
              alt={imgAlt}
              class="w-full max-w-[800px] h-[320px] sm:h-[380px] md:h-[420px] lg:h-[460px] object-contain scale-150"
              loading="lazy"
            />
          </div>
        ) : (
          <div class="h-[320px] sm:h-[360px] md:h-[420px] grid place-content-center text-white/80">
            {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
          </div>
        )}
      </div>

      <!-- ขวา: ข้อความ + ปุ่ม (จัด center, ขยายฟอนต์, ขยับปุ่มลง) -->
      <div class="text-white text-center">
        <h2 class="font-extrabold leading-tight text-3xl sm:text-4xl md:text-5xl lg:text-6xl">
          {titleText}
        </h2>

        {descHtml && (
          <div
            class="prose prose-invert max-w-none mx-auto mt-4 mb-8 prose-p:my-2 text-base sm:text-lg"
            set:html={descHtml}
          />
        )}

        <div class="mt-8 sm:mt-10 flex flex-wrap items-center justify-center gap-4 sm:gap-5">
          <!-- Google Play - แค่ icon กับชื่อ -->
          <a
            href={googlePlay}
            target="_blank" rel="noopener"
            class="store-badge inline-flex items-center rounded-xl bg-white text-gray-900 px-6 py-3.5 shadow hover:shadow-md transition"
            aria-label="Get it on Google Play"
          >
            <img 
              src="/blackgoogleplay.png" 
              alt="Google Play" 
              class="h-8 sm:h-9 w-auto mr-3" 
            />
      
          </a>

          <!-- App Store - แค่ icon กับชื่อ -->
          <a
            href={appStore}
            target="_blank" rel="noopener"
            class="store-badge inline-flex items-center rounded-xl bg-white text-gray-900 px-6 py-3.5 shadow hover:shadow-md transition"
            aria-label="Download on the App Store"
          >
            <img 
              src="/apple.png" 
              alt="App Store" 
              class="h-8 sm:h-9 w-auto mr-3" 
            />
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .prose :where(p){ margin: .45rem 0; }
  .store-badge { will-change: transform, box-shadow; }
  .store-badge:hover { transform: translateY(-1.5px); }
</style>