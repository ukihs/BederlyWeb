---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  class?: string;
}

const { lang, class: sectionClass = "" } = Astro.props;
const categorySlug = lang === "en" ? "download-en" : "download-th";

const DOWNLOAD_QUERY = /* GraphQL */ `
  query DownloadByCategory($slug: String!) {
    posts(
      first: 1
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        excerpt
        content
        featuredImage {
          node {
            altText
            sourceUrl
            mediaDetails { sizes { name sourceUrl width height } }
          }
        }
      }
    }
  }
`;

type Size = { name: string; sourceUrl?: string };
type Img  = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined { return img?.node ? img.node : img ?? undefined; }
function pickImageUrl(img: any): string | undefined {
  const n = normalize(img); if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}
function htmlOrBlank(s?: string) {
  const t = (s ?? "").trim();
  return t && t.replace(/(<[^>]*>)|(&nbsp;)|\s+/g, "") !== "" ? t : "";
}

let post: any | undefined;
try {
  const res = await wpQuery<any>(DOWNLOAD_QUERY, { slug: categorySlug });
  post = res?.posts?.nodes?.[0];
} catch {}

const rawTitle =
  (post?.title as string) ||
  (lang === "en"
    ? "Download|the Bederly PHR App|to track your health"
    : "ดาวน์โหลด|Bederly PHR|เพื่อติดตามสุขภาพของคุณ");

const titleHtml = rawTitle
  .replace(/\r\n|\r|\n/g, "<br/>")
  .replace(/\s*\|\s*/g, "<br/>");

const titlePlain = rawTitle
  .replace(/\r\n|\r|\n/g, " ")
  .replace(/\s*\|\s*/g, " ")
  .trim();

const descHtml = htmlOrBlank(post?.excerpt) || htmlOrBlank(post?.content) || "";
const imgUrl   = pickImageUrl(post?.featuredImage);
const imgAlt   = normalize(post?.featuredImage)?.altText || titlePlain;

const googlePlay = "https://play.google.com/store/apps/details?id=com.bederly.phr";
const appStore   = "https://apps.apple.com/th/app/bederly-phr/id6747645978";
---

<section class={`relative isolate py-14 md:py-16 lg:py-20 mobile-section ${sectionClass}`.trim()}>
  <div
    class="pointer-events-none absolute inset-x-0 top-1/2 -translate-y-1/2 z-0
           h-[300px] sm:h-[340px] lg:h-[380px]
           bg-gradient-to-r from-sky-600 via-sky-500 to-cyan-400 mobile-blue-bg">
  </div>

  <!-- Desktop -->
  <div class="container-primary relative z-10 hidden md:block">
    <div class="grid md:grid-cols-2 gap-10 lg:gap-16 items-center">
      <div class="order-1 md:order-none">
        {imgUrl ? (
          <div class="inline-block p-3">
            <img
              src={imgUrl}
              alt={imgAlt}
              class="w-full max-w-[800px] h-[420px] object-contain scale-150"
              loading="lazy"
            />
          </div>
        ) : (
          <div class="h-[420px] grid place-content-center text-white/80">
            {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
          </div>
        )}
      </div>

      <div class="text-white text-center">
        <h2
          class="font-extrabold leading-tight text-3xl sm:text-4xl md:text-5xl lg:text-6xl"
          set:html={titleHtml}>
        </h2>

        {descHtml && (
          <div
            class="prose prose-invert max-w-none mx-auto mt-4 mb-8 prose-p:my-2 text-base sm:text-lg"
            set:html={descHtml}
          />
        )}

        <!-- ปุ่มสโตร์ (Desktop) -->
        <div class="mt-8 sm:mt-10 flex flex-wrap items-center justify-center gap-4 sm:gap-5">
          <a
            href={googlePlay}
            target="_blank" rel="noopener"
            class="store-badge badge-invert inline-flex items-center justify-center rounded-xl bg-white text-gray-900 shadow transition"
            aria-label="Get it on Google Play"
          >
            <img src="/blackgoogleplay.png" alt="Google Play" class="h-10 w-auto" />
          </a>

          <a
            href={appStore}
            target="_blank" rel="noopener"
            class="store-badge badge-invert inline-flex items-center justify-center rounded-xl bg-white text-gray-900 shadow transition"
            aria-label="Download on the App Store"
          >
            <img src="/apple.png" alt="App Store" class="h-10 w-auto" />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile -->
  <div class="md:hidden mobile-wrapper">
    <div class="relative z-10 flex items-center justify-center mobile-image-container">
      {imgUrl ? (
        <img src={imgUrl} alt={imgAlt} class="mobile-full-image" loading="lazy" />
      ) : (
        <div class="h-[300px] grid place-content-center text-white/80 px-4">
          {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
        </div>
      )}

      <!-- ปุ่มบนมือถือ -->
      <div class="absolute top-4 right-4 z-30 flex flex-col gap-3 mobile-buttons-overlay">
        <a href={googlePlay} target="_blank" rel="noopener" class="store-badge badge-invert w-full max-w-[140px] h-[50px] flex items-center justify-center" aria-label="Get it on Google Play">
          <img src="/blackgoogleplay.png" alt="Google Play" class="w-auto h-8" />
        </a>
        <a href={appStore} target="_blank" rel="noopener" class="store-badge badge-invert w-full max-w-[140px] h-[50px] flex items-center justify-center" aria-label="Download on the App Store">
          <img src="/apple.png" alt="App Store" class="w-auto h-8" />
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  .prose :where(p){ margin: .45rem 0; }

  /* ========== ปรับขนาดปุ่มให้เท่ากันทุกอัน ========== */
  .store-badge {
    width: 200px;
    height: 60px;
    padding: 0;
    border-radius: 40px;
    will-change: transform, box-shadow;
    transition: background-color .25s ease, color .25s ease, transform .2s ease;
  }

  /* ========== เอฟเฟกต์สลับขาว–ดำตอน hover ========== */
  .badge-invert {
    background-color: #ffffff;
    color: #111827;
  }

  .badge-invert img {
    transition: filter .25s ease;
  }

  .badge-invert:hover {
    background-color: #000000 !important;
    color: #ffffff !important;
  }

  .badge-invert:hover img {
    filter: invert(1) brightness(1.05) contrast(1.05);
  }

  @media (hover:none) and (pointer:coarse) {
    .badge-invert:active {
      background-color: #000000 !important;
      color: #ffffff !important;
    }
    .badge-invert:active img {
      filter: invert(1) brightness(1.05) contrast(1.05);
    }
  }

  /* ========== มือถือ ========== */
  @media (max-width: 767.98px) {
    .mobile-section {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      overflow-x: hidden !important;
      max-width: 100vw !important;
    }

    .mobile-wrapper {
      width: 100% !important;
      overflow: hidden !important;
      position: relative !important;
    }

    .mobile-image-container {
      min-height: 420px;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      position: relative !important;
    }

    .mobile-full-image {
      width: 100% !important;
      object-fit: contain !important;
      transform: scale(1.4) !important;
    }

    .mobile-buttons-overlay .store-badge {
      background: white !important;
      border-radius: 14px !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }
    .mobile-buttons-overlay .store-badge:active {
      transform: scale(0.95) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
  }
</style>
