---
// src/components/DownloadCTA_Band.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  class?: string;
}

const { lang, class: sectionClass = "" } = Astro.props;
const categorySlug = lang === "en" ? "download-en" : "download-th";

const DOWNLOAD_QUERY = /* GraphQL */ `
  query DownloadByCategory($slug: String!) {
    posts(
      first: 1
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        excerpt
        content
        featuredImage {
          node {
            altText
            sourceUrl
            mediaDetails { sizes { name sourceUrl width height } }
          }
        }
      }
    }
  }
`;

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined { return img?.node ? img.node : img ?? undefined; }
function pickImageUrl(img: any): string | undefined {
  const n = normalize(img); if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "1536x1536", "large", "medium_large"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}
function htmlOrBlank(s?: string) {
  const t = (s ?? "").trim();
  return t && t.replace(/(<[^>]*>)|(&nbsp;)|\s+/g, "") !== "" ? t : "";
}

let post: any | undefined;
try {
  const res = await wpQuery<any>(DOWNLOAD_QUERY, { slug: categorySlug });
  post = res?.posts?.nodes?.[0];
} catch {}

const titleText =
  (post?.title as string) ||
  (lang === "en"
    ? "Download the Bederly PHR App to track your health"
    : "ดาวน์โหลดแอป Bederly PHR เพื่อติดตามสุขภาพของคุณ");

const descHtml = htmlOrBlank(post?.excerpt) || htmlOrBlank(post?.content) || "";
const imgUrl = pickImageUrl(post?.featuredImage);
const imgAlt = normalize(post?.featuredImage)?.altText || titleText;

const googlePlay = "https://play.google.com/store/apps/details?id=com.bederly.phr";
const appStore   = "https://apps.apple.com/th/app/id0000000000";
---

<section class={`relative isolate py-14 md:py-16 lg:py-20 mobile-section ${sectionClass}`.trim()}>
  <!-- แถบพื้นหลังฟ้าไล่เฉด: สี่เหลี่ยมคม (ไม่โค้ง) และสูงขึ้น -->
  <div
    class="pointer-events-none absolute inset-x-0 top-1/2 -translate-y-1/2 z-0
           h-[300px] sm:h-[340px] lg:h-[380px]
           bg-gradient-to-r from-sky-600 via-sky-500 to-cyan-400
           mobile-blue-bg">
  </div>

  <!-- Desktop Layout - ไม่แก้ไขโค้ด Win -->
  <div class="container-primary relative z-10 hidden md:block">
    <div class="grid md:grid-cols-2 gap-10 lg:gap-16 items-center">
      <!-- ซ้าย: รูปจาก WordPress (ไม่แก้ไข) -->
      <div class="order-1 md:order-none">
        {imgUrl ? (
          <div class="inline-block p-3">
            <img
              src={imgUrl}
              alt={imgAlt}
              class="w-full max-w-[800px] h-[320px] sm:h-[380px] md:h-[420px] lg:h-[460px] object-contain scale-150"
              loading="lazy"
            />
          </div>
        ) : (
          <div class="h-[320px] sm:h-[360px] md:h-[420px] grid place-content-center text-white/80">
            {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
          </div>
        )}
      </div>

      <!-- ขวา: ข้อความ + ปุ่ม (Desktop - ไม่แก้ไข) -->
      <div class="text-white text-center">
        <h2 class="font-extrabold leading-tight text-3xl sm:text-4xl md:text-5xl lg:text-6xl">
          {titleText}
        </h2>

        {descHtml && (
          <div
            class="prose prose-invert max-w-none mx-auto mt-4 mb-8 prose-p:my-2 text-base sm:text-lg"
            set:html={descHtml}
          />
        )}

        <div class="mt-8 sm:mt-10 flex flex-wrap items-center justify-center gap-4 sm:gap-5">
          <!-- Google Play - Desktop -->
          <a
            href={googlePlay}
            target="_blank" rel="noopener"
            class="store-badge inline-flex items-center rounded-xl bg-white text-gray-900 px-6 py-3.5 shadow hover:shadow-md transition"
            aria-label="Get it on Google Play"
          >
            <img 
              src="/blackgoogleplay.png" 
              alt="Google Play" 
              class="h-8 sm:h-9 w-auto mr-3" 
            />
          </a>

          <!-- App Store - Desktop -->
          <a
            href={appStore}
            target="_blank" rel="noopener"
            class="store-badge inline-flex items-center rounded-xl bg-white text-gray-900 px-6 py-3.5 shadow hover:shadow-md transition"
            aria-label="Download on the App Store"
          >
            <img 
              src="/apple.png" 
              alt="App Store" 
              class="h-8 sm:h-9 w-auto mr-3" 
            />
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Layout - แก้ไขเฉพาะส่วนนี้ -->
  <div class="md:hidden mobile-wrapper">
    <!-- รูปอยู่ตรงกลางแถบสีฟ้า - ขยายใหญ่และล้นออกจากกรอบ -->
    <div class="relative z-10 flex items-center justify-center mobile-image-container">
      {imgUrl ? (
        <img
          src={imgUrl}
          alt={imgAlt}
          class="mobile-full-image"
          loading="lazy"
        />
      ) : (
        <div class="h-[300px] grid place-content-center text-white/80 px-4">
          {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
        </div>
      )}
      
      <!-- ปุ่มอยู่ในแถบสีฟ้า มุมบนขวา -->
      <div class="absolute top-4 right-4 z-30 flex flex-col gap-3 mobile-buttons-overlay">
        <!-- Google Play -->
        <a
          href={googlePlay}
          target="_blank" rel="noopener"
          class="store-badge w-full max-w-[120px]"
          aria-label="Get it on Google Play"
        >
          <img 
            src="/blackgoogleplay.png" 
            alt="Google Play" 
            class="w-full h-auto" 
          />
        </a>

        <!-- App Store -->
        <a
          href={appStore}
          target="_blank" rel="noopener"
          class="store-badge w-full max-w-[120px]"
          aria-label="Download on the App Store"
        >
          <img 
            src="/apple.png" 
            alt="App Store" 
            class="w-full h-auto" 
          />
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  .prose :where(p){ margin: .45rem 0; }
  .store-badge { will-change: transform, box-shadow; }
  .store-badge:hover { transform: translateY(-1.5px); }

  /* Mobile-specific styles - รูปล้นออกจากกรอบสีฟ้า */
  @media (max-width: 767.98px) {
    /* เอา padding ของ section ออกบน mobile */
    .mobile-section {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      overflow: visible !important;
    }

    /* ปรับแถบสีฟ้า - ให้รูปล้นออกได้ */
    .mobile-blue-bg {
      height: 420px !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      transform: none !important;
      width: 100vw !important;
      margin-left: calc(-50vw + 50%) !important;
      overflow: visible !important;
    }

    /* Container ของรูปให้เต็มความกว้าง */
    .mobile-wrapper {
      width: 100% !important;
      overflow: visible !important;
      position: relative !important;
    }

    /* รูปอยู่ตรงกลางและล้นออกจากกรอบสีฟ้า */
    .mobile-image-container {
      min-height: 420px;
      padding: 0 !important;
      width: 100% !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: visible !important;
      position: relative !important;
      z-index: 10 !important;
    }

    /* รูปให้ใหญ่และล้นออกจากกรอบ */
    .mobile-full-image {
      width: 100% !important;
      max-width: none !important;
      height: auto !important;
      object-fit: contain !important;
      transform: scale(1.6) !important;
      transform-origin: center !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* ปุ่มอยู่ในแถบสีฟ้า มุมบนขวา */
    .mobile-buttons-overlay {
      position: absolute !important;
      top: 1rem !important;
      right: 1rem !important;
      z-index: 30 !important;
    }

    .mobile-buttons-overlay .store-badge {
      display: block !important;
      background: white !important;
      border-radius: 12px !important;
      padding: 0.5rem !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }

    .mobile-buttons-overlay .store-badge:active {
      transform: scale(0.95) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }

    .mobile-buttons-overlay .store-badge img {
      display: block !important;
      width: 100% !important;
      height: auto !important;
    }

    /* ปรับ store badge บน mobile */
    .store-badge {
      display: block;
      transition: transform 0.2s ease;
    }

    .store-badge:active {
      transform: scale(0.98);
    }
  }
</style>