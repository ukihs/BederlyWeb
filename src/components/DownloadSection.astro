---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  class?: string;
}

const { lang, class: sectionClass = "" } = Astro.props;

// ใช้ slug ตามภาษา
const categorySlug = lang === "en" ? "download-en" : "download-th";

// ดึงโพสต์ตัวแรกในหมวด download-xx
const DOWNLOAD_QUERY = /* GraphQL */ `
  query DownloadByCategory($slug: String!) {
    posts(
      first: 1
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        excerpt
        content
        featuredImage {
          node {
            altText
            sourceUrl
            mediaDetails {
              sizes { name sourceUrl width height }
            }
          }
        }
      }
    }
  }
`;

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined {
  return img?.node ? img.node : img ?? undefined;
}

function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  // เลือก size ที่ใหญ่พอ
  const prefer = ["1536x1536", "2048x2048", "large", "medium_large"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

function htmlOrBlank(s?: string) {
  const t = (s ?? "").trim();
  return t && t.replace(/(<[^>]*>)|(&nbsp;)|\s+/g, "") !== "" ? t : "";
}

let post: any | undefined;
try {
  const res = await wpQuery<any>(DOWNLOAD_QUERY, { slug: categorySlug });
  post = res?.posts?.nodes?.[0];
} catch {}

const titleText =
  (post?.title as string) ??
  (lang === "en"
    ? "Download the Bederly PHR App to track your health"
    : "ดาวน์โหลดแอป Bederly PHR เพื่อติดตามสุขภาพของคุณ");

const descHtml =
  htmlOrBlank(post?.excerpt) ||
  htmlOrBlank(post?.content) ||
  "";

const imgUrl = pickImageUrl(post?.featuredImage);
const imgAlt = normalize(post?.featuredImage)?.altText || titleText;

// ลิงก์ปุ่ม (hardcode)
const googlePlay =
  "https://play.google.com/store/apps/details?id=com.bederly.phr";
const appStore =
  "https://apps.apple.com/th/app/bederly-phr/idXXXXXXXXXX"; // ใส่ไอดีจริงภายหลัง
---

<section class={`section-padding ${sectionClass}`.trim()}>
  <div class="container-primary">
    <div class="rounded-[28px] p-6 md:p-10 bg-gradient-to-br from-cyan-500 via-sky-500 to-blue-400 shadow-[0_25px_80px_-20px_rgba(0,0,0,.25)]">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <!-- ซ้าย: ข้อความ + ปุ่ม -->
        <div>
          <h2 class="text-white text-2xl md:text-4xl font-bold mb-3">
            {titleText}
          </h2>

          {descHtml && (
            <div
              class="prose prose-invert max-w-none mb-6 prose-p:my-2"
              set:html={descHtml}
            />
          )}

          <div class="flex gap-4">
            <a
              href={googlePlay}
              class="inline-flex items-center gap-3 px-5 py-3 rounded-xl bg-white/90 hover:bg-white text-gray-800 font-medium shadow transition"
              target="_blank" rel="noopener"
            >
              <img src="/images/google-play-badge.svg" alt="" class="h-6" />
              <span class="hidden sm:inline">Google Play</span>
            </a>

            <a
              href={appStore}
              class="inline-flex items-center gap-3 px-5 py-3 rounded-xl bg-white/90 hover:bg-white text-gray-800 font-medium shadow transition"
              target="_blank" rel="noopener"
            >
              <img src="/images/app-store-badge.svg" alt="" class="h-6" />
              <span class="hidden sm:inline">App Store</span>
            </a>
          </div>
        </div>

        <!-- ขวา: ภาพจาก Featured Image -->
        <div class="relative">
          {imgUrl ? (
            <div class="rounded-3xl bg-white/10 ring-1 ring-white/20 p-2">
              <img
                src={imgUrl}
                alt={imgAlt}
                class="w-full h-[280px] sm:h-[340px] md:h-[380px] lg:h-[420px] object-contain rounded-2xl bg-white"
                loading="lazy"
              />
            </div>
          ) : (
            <div class="h-[260px] sm:h-[320px] md:h-[360px] rounded-3xl bg-white/10 ring-1 ring-white/20 grid place-content-center text-white/70">
              {lang === "en" ? "Add a featured image to the Download post" : "เพิ่มรูป Featured Image ในโพสต์ Download"}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>
