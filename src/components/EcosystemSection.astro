---
// src/components/EcosystemSection.astro - Sharp Corners Version
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  pageUriTH?: string;
  pageUriEN?: string;
  class?: string;
  size?: "sm" | "md" | "lg";
}

const {
  lang,
  pageUriTH = "/",
  pageUriEN = "/en/welcome/",
  class: klass = "",
  size = "lg",
} = Astro.props;

const uri = lang === "en" ? pageUriEN : pageUriTH;

const QUERY = /* GraphQL */ `
  query EcosystemByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        ecosystem {
          ecotitle
          ecoimage {
            node {
              sourceUrl
              mediaDetails { sizes { name sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

function pickImageUrl(img: any): string | undefined {
  const node = img?.node ?? img;
  if (!node) return;
  const sizes = node.mediaDetails?.sizes ?? [];
  const prefer = ["full","2048x2048","large","1536x1536","medium_large","medium"];
  for (const k of prefer) {
    const hit = sizes.find((s:any)=>s?.name===k && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return node.sourceUrl ? rewriteWpUrl(node.sourceUrl) : undefined;
}

let title = "";
let bgUrl = "";
try {
  const res = await wpQuery<any>(QUERY, { uri });
  const eco = res?.nodeByUri?.ecosystem ?? null;
  title = eco?.ecotitle ?? "";
  bgUrl = pickImageUrl(eco?.ecoimage) || "";
} catch {}

let displayTitle = (title || "")
  .replace(/\r\n|\r|\n/g, "<br/>")
  .replace(/\s*\|\s*/g, "<br/>");

const HEIGHT =
  size === "sm"
    ? "h-[440px] md:h-[520px] lg:h-[580px]"
    : size === "md"
    ? "h-[520px] md:h-[600px] lg:h-[680px]"
    : "h-[600px] md:h-[680px] lg:h-[760px]";

const TITLE = "text-2xl md:text-3xl lg:text-4xl";
---

<section class={`${klass}`}>
  <div class="container-primary">
    <!-- Card with sharp corners -->
    <div class={`card relative overflow-hidden ${HEIGHT}`}>
      {/* === รูป + Overlay ทั้งหมดอยู่ใน .clipper เพื่อกันล้นบนมือถือ === */}
      <div class="clipper absolute inset-0">
        {bgUrl ? (
          <>
            {/* มือถือ: BG cover (กันล้น) */}
            <div
              aria-hidden="true"
              style={`background-image:url('${bgUrl}');`}
              class="mobile-bg absolute inset-0 md:hidden"
            />
            {/* เดสก์ท็อป/แท็บเล็ต: คง <img> เดิม */}
            <img
              src={bgUrl}
              alt=""
              class="absolute inset-0 w-full h-full object-fill hidden md:block"
              loading="eager"
              decoding="async"
            />
            {/* Overlays */}
            <div class="absolute inset-0 bg-black/40"></div>
            <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-b from-transparent to-black/35"></div>
          </>
        ) : (
          <div class="absolute inset-0" />
        )}
      </div>

      <div class="relative h-full flex items-center">
        <div class="container-primary">
          {displayTitle && (
            <h3
              class={`eco-title font-extrabold leading-tight text-white drop-shadow-lg text-center ${TITLE}
                       mx-auto max-w-4xl md:max-w-5xl`}
              set:html={displayTitle}
            />
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  @supports (text-wrap: balance) { .eco-title { text-wrap: balance; } }
  .eco-title { word-break: break-word; }

  /* ขอบเหลี่ยม - ลบ border-radius ออกหมด */
  .card {
    border-radius: 0 !important;
  }

  /* ===== MOBILE ONLY ===== */
  @media (max-width: 767.98px) {
    /* กันหน้าเพจเลื่อนไปด้านข้าง */
    section, :global(body) { overflow-x: hidden !important; }

    /* ตัวการ์ดไม่ให้รั่วเกินมุมโค้ง (iOS-safe) - เปลี่ยนเป็นขอบเหลี่ยม */
    .card {
      border-radius: 0 !important;
      contain: layout paint;
      overflow: hidden;
    }
    .clipper {
      border-radius: 0 !important;
      overflow: clip;
      -webkit-mask-image: none; /* ไม่ต้อง mask เพราะเป็นขอบเหลี่ยม */
      clip-path: none;
    }

    /* ความสูงบนมือถือ */
    section .h-\[440px\] { height: 300px !important; }
    section .h-\[520px\] { height: 340px !important; }
    section .h-\[600px\] { height: 380px !important; }

    /* รูปแบบ BG มือถือ */
    .mobile-bg {
      background-size: cover !important;
      background-position: center 24% !important;
      background-repeat: no-repeat !important;
    }

    /* ปิด object-fill เดิม */
    .object-fill { object-fit: cover !important; }

    /* ตัวหนังสือให้อ่านง่าย */
    .eco-title {
      font-size: 1rem !important;
      line-height: 1.35 !important;
      padding: 0 1.25rem;
      max-width: 85% !important;
    }
  }
</style>