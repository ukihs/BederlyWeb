---
// src/components/EcosystemSection.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  pageUriTH?: string;
  pageUriEN?: string;
  class?: string;
  /** ปรับความสูงการ์ด: 'sm' | 'md' | 'lg' (default: 'lg') */
  size?: "sm" | "md" | "lg";
}

const {
  lang,
  pageUriTH = "/",
  pageUriEN = "/en/welcome/",
  class: klass = "",
  size = "lg",
} = Astro.props;

const uri = lang === "en" ? pageUriEN : pageUriTH;

/* ====== GQL ====== */
const QUERY = /* GraphQL */ `
  query EcosystemByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        ecosystem {
          ecotitle
          ecoimage {
            node {
              sourceUrl
              mediaDetails { sizes { name sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

function pickImageUrl(img: any): string | undefined {
  const node = img?.node ?? img;
  if (!node) return;
  const sizes = node.mediaDetails?.sizes ?? [];
  const prefer = ["2048x2048", "large", "1536x1536", "medium_large", "medium"];
  for (const k of prefer) {
    const hit = sizes.find((s: any) => s?.name === k && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return node.sourceUrl ? rewriteWpUrl(node.sourceUrl) : undefined;
}

/* ====== data ====== */
let title = "";
let bgUrl = "";
try {
  const res = await wpQuery<any>(QUERY, { uri });
  const eco = res?.nodeByUri?.ecosystem ?? null;
  title = eco?.ecotitle ?? "";
  bgUrl = pickImageUrl(eco?.ecoimage) || "";
} catch {}

/* ทำให้ตัดบรรทัด “ตามที่ตั้งใจ”:
   - รองรับ \n (Enter) และเครื่องหมาย | เป็นตัวแบ่ง
   - แปลงเป็น <br/> เพื่อคุมบรรทัดแน่นอนทุกเบราว์เซอร์
*/
let displayTitle = (title || "")
  .replace(/\r\n|\r|\n/g, "<br/>")
  .replace(/\s*\|\s*/g, "<br/>");

/* ====== expanded size ====== */
const HEIGHT =
  size === "sm"
    ? "h-[440px] md:h-[520px] lg:h-[580px]"
    : size === "md"
    ? "h-[520px] md:h-[600px] lg:h-[680px]"
    : "h-[600px] md:h-[680px] lg:h-[760px]"; // 'lg' (default)

const TITLE = "text-2xl md:text-3xl lg:text-4xl";
---

<section class={`${klass}`}>
  <div class="container-primary">
    <div class={`relative overflow-hidden rounded-[32px] md:rounded-[40px] ${HEIGHT}`}>
      {bgUrl ? (
        <>
          <img
            src={bgUrl}
            alt=""
            class="absolute inset-0 w-full h-full object-fill"
            loading="eager"
            decoding="async"
          />
          <!-- Overlay -->
          <div class="absolute inset-0 bg-black/40"></div>
          <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-b from-transparent to-black/35"></div>
        </>
      ) : (
        <div class="absolute inset-0" />
      )}

      <div class="relative h-full flex items-center">
        <div class="container-primary">
          {displayTitle && (
            <h3
              class={`eco-title font-extrabold leading-tight text-white drop-shadow-lg text-center ${TITLE}
                       mx-auto max-w-4xl md:max-w-5xl`}
              set:html={displayTitle}
            />
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* ทำให้การขึ้นบรรทัดสวยขึ้นเมื่อเบราว์เซอร์รองรับ */
  @supports (text-wrap: balance) {
    .eco-title { text-wrap: balance; }
  }
  /* กันคำยาว ๆ ไม่ล้นกรอบ */
  .eco-title { word-break: break-word; }
</style>
