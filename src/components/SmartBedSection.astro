---
// src/components/SmartBedSection.astro - Sharp Corners Version
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
}

const { lang = "th" } = Astro.props;

// แปลง lang เป็น GraphQL enum
const languageFilter = lang.toUpperCase() as "TH" | "EN";

// ใช้ URI candidates เหมือน Hero section
const uriCandidates = lang === "en" 
  ? ["/", "/home/", "/home", "/en/", "/en"]
  : ["/", "/th/", "/th", "/หน้าแรก/", "/หน้าแรก"];

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined {
  return img?.node ? img.node : img ?? undefined;
}

function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

// Language-specific query
const SMARTBED_LANGUAGE_QUERY = /* GraphQL */ `
  query SmartBedByLanguage($language: LanguageCodeFilterEnum!) {
    pages(
      first: 10
      where: { 
        language: $language,
        status: PUBLISH
      }
    ) {
      nodes {
        id
        title
        uri
        slug
        isFrontPage
        language {
          code
          name
        }
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails {
                width
                height
                sizes {
                  name
                  width
                  height
                  sourceUrl
                }
              }
            }
          }
        }
      }
    }
  }
`;

// Fallback URI-based query
const SMARTBED_URI_QUERY = /* GraphQL */ `
  query SmartBedByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        id
        title
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails {
                width
                height
                sizes {
                  name
                  width
                  height
                  sourceUrl
                }
              }
            }
          }
        }
      }
    }
  }
`;

let smartbedTitle = "";
let smartbedSub = "";
let smartbedImageUrl = "";
let foundSmartbedData = false;

// 1. Language-specific query
try {
  const languageData = await wpQuery<any>(SMARTBED_LANGUAGE_QUERY, { 
    language: languageFilter 
  });
  
  const pages = languageData?.pages?.nodes || [];
  let targetPage = pages.find((p: any) => p.isFrontPage && p.smartbed) ||
    pages.find((p: any) => p.smartbed && (p.smartbed.smartbedtitle || p.smartbed.smartbedimage));
  
  if (targetPage?.smartbed) {
    const smartbed = targetPage.smartbed;
    smartbedTitle = smartbed?.smartbedtitle || smartbedTitle;
    smartbedSub = smartbed?.smartbedsub || smartbedSub;
    smartbedImageUrl = pickImageUrl(smartbed?.smartbedimage) || smartbedImageUrl;
    
    if (smartbedTitle || smartbedSub || smartbedImageUrl) {
      foundSmartbedData = true;
    }
  }
} catch (e) {
  console.warn(`[SMARTBED] Language-specific query failed:`, e);
}

// 2. Fallback URI-based query
if (!foundSmartbedData) {
  for (const uri of uriCandidates) {
    try {
      const data = await wpQuery<any>(SMARTBED_URI_QUERY, { uri });
      const smartbed = data?.nodeByUri?.smartbed;
      
      if (!smartbed) continue;

      smartbedTitle = smartbed?.smartbedtitle || smartbedTitle;
      smartbedSub = smartbed?.smartbedsub || smartbedSub;
      smartbedImageUrl = pickImageUrl(smartbed?.smartbedimage) || smartbedImageUrl;

      if (smartbedTitle || smartbedSub || smartbedImageUrl) {
        foundSmartbedData = true;
        break;
      }
    } catch (e) {
      console.warn(`[SMARTBED] URI query failed for ${uri}:`, e);
    }
  }
}
---

<!-- Smart Bed Section — ขอบเหลี่ยม -->
<section class="pt-12 md:pt-14 lg:pt-16 pb-2 md:pb-3 lg:pb-4 bg-white overflow-x-clip">
  <div class="container-primary smartbed-container">
    <!-- Card with sharp corners (เปลี่ยนจาก rounded เป็น ไม่มีมุมโค้ง) -->
    <div class="relative overflow-hidden shadow-2xl md:min-h-[680px] lg:min-h-[760px]">

      <!-- BG image covers the whole card -->
      {smartbedImageUrl ? (
        <img
          src={smartbedImageUrl}
          alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          class="absolute inset-0 w-full h-full object-cover"
          loading="lazy"
        />
      ) : (
        <div class="absolute inset-0 bg-blue-200" />
      )}

      <!-- Content on top of image -->
      <div class="relative z-10 grid lg:grid-cols-2 items-center gap-8 p-10 md:p-16 lg:p-20">
        <div class="max-w-xl lg:max-w-2xl text-white">
          <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
            {lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          </h2>

          <h3 class="text-xl md:text-2xl lg:text-3xl font-medium mb-8">
            {smartbedTitle ||
              (lang === "en"
                ? "Innovative Care for the Ones Your loved ones"
                : "นวัตกรรมดูแลสุขภาพของคนที่คุณรัก")}
          </h3>

          <p class="text-base md:text-lg/8 lg:text-xl/9 mb-10 opacity-95">
            {smartbedSub ||
              (lang === "en"
                ? "The smart bed is an electric bed that distributes pressure and supports caregivers in repositioning patients. With IoT integration, it can be controlled remotely via smartphone. Embedded technology enhances its intelligence, enabling seamless connection and interaction with other devices."
                : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย ด้วยการผสาน IOT สามารถควบคุมระยะไกลผ่านสมาร์ทโฟน เทคโนโลยีฝังตัวช่วยเพิ่มความอัจฉริยะ ทำให้เชื่อมต่อและโต้ตอบกับอุปกรณ์อื่นได้อย่างราบรื่น")}
          </p>
          <a
            href="#footer"
            class="inline-flex items-center gap-2 bg-white text-cyan-700 px-8 py-4 font-semibold text-lg hover:bg-gray-50 transition shadow-lg"
          >
            {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>

        <div class="hidden lg:block"></div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Mobile Only - แบบรูปตัวอย่างซ้าย กรอบฟ้าโค้งมน */
  @media (max-width: 767.98px) {
    section {
      padding: 1rem !important;
    }
    
    .smartbed-container {
      padding: 0 !important;
    }
    
    /* การ์ดสีฟ้าขอบเหลี่ยม */
    .smartbed-container > div {
      background: #40B4E4 !important;
      border-radius: 0 !important; /* เปลี่ยนเป็นขอบเหลี่ยม */
      min-height: auto !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
      position: relative !important;
      overflow: hidden !important;
      display: flex !important;
      flex-direction: column !important;
      padding: 0 !important;
    }
    
    /* ซ่อนรูป background แบบเดิม */
    .smartbed-bg-image {
      display: none !important;
    }
    
    /* Content wrapper */
    .smartbed-content-wrapper {
      position: relative !important;
      z-index: 10 !important;
      display: flex !important;
      flex-direction: column !important;
      padding: 0 !important;
      background: transparent !important;
      gap: 0 !important;
    }
    
    /* Text content - บนสุด - ลดขนาดมากขึ้น */
    .smartbed-text-content {
      background: transparent !important;
      padding: 1.5rem 1rem 0.75rem !important;
      max-width: 100% !important;
      width: 100% !important;
    }
    
    .smartbed-text-content h2 {
      font-size: 1.5rem !important;
      line-height: 1.2 !important;
      margin-bottom: 0.5rem !important;
      color: white !important;
      text-shadow: none !important;
    }
    
    .smartbed-text-content h3 {
      font-size: 0.9375rem !important;
      line-height: 1.4 !important;
      margin-bottom: 0.5rem !important;
      color: white !important;
      text-shadow: none !important;
    }
    
    /* ซ่อน desktop description และ CTA */
    .smartbed-text-content .smartbed-description,
    .smartbed-desktop-cta {
      display: none !important;
    }
    
    /* แสดงรูปเตียงจาก mobile-image */
    .smartbed-mobile-image {
      display: block !important;
      width: 100% !important;
      position: relative !important;
      padding: 0 !important;
      margin: 0 !important;
      max-height: 200px !important;
      overflow: hidden !important;
    }
    
    .smartbed-mobile-image img {
      width: 100% !important;
      height: auto !important;
      display: block !important;
      max-width: 100% !important;
      max-height: 200px !important;
      object-fit: contain !important;
    }
    
    /* Mobile bottom section */
    .smartbed-mobile-bottom {
      display: flex !important;
      flex-direction: column !important;
      padding: 0 !important;
    }
    
    /* Mobile description */
    .smartbed-mobile-description {
      font-size: 0.75rem !important;
      line-height: 1.6 !important;
      padding: 0.75rem 1rem !important;
      color: white !important;
      margin: 0 !important;
    }
    
    /* ปุ่มอยู่ล่างสุด */
    .smartbed-mobile-cta {
      display: flex !important;
      justify-content: center !important;
      padding: 0.5rem 1rem 1.5rem !important;
    }
    
    .smartbed-mobile-cta a {
      padding: 0.75rem 2rem !important;
      font-size: 0.9375rem !important;
      background: white !important;
      color: #40B4E4 !important;
      border-radius: 0 !important; /* ปุ่มก็ขอบเหลี่ยม */
      display: inline-flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      font-weight: 600 !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* ซ่อน empty div ที่ใช้บน desktop */
    .smartbed-content-wrapper > div:last-child:empty {
      display: none !important;
    }
  }
</style>