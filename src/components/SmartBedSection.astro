---
// src/components/SmartBedSection.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
}

const { lang = "th" } = Astro.props;
const languageFilter = lang.toUpperCase() as "TH" | "EN";

const uriCandidates = lang === "en"
  ? ["/", "/home/", "/home", "/en/", "/en"]
  : ["/", "/th/", "/th", "/หน้าแรก/", "/หน้าแรก"];

type Size = { name: string; sourceUrl?: string };
type Img = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined {
  return img?.node ? img.node : img ?? undefined;
}

function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

const SMARTBED_LANGUAGE_QUERY = /* GraphQL */ `
  query SmartBedByLanguage($language: LanguageCodeFilterEnum!) {
    pages(first: 10, where: { language: $language, status: PUBLISH }) {
      nodes {
        id
        title
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails { width height sizes { name width height sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

const SMARTBED_URI_QUERY = /* GraphQL */ `
  query SmartBedByUri($uri: String!) {
    nodeByUri(uri: $uri) {
      ... on Page {
        id
        title
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage {
            node {
              id
              altText
              sourceUrl
              mediaDetails { width height sizes { name width height sourceUrl } }
            }
          }
        }
      }
    }
  }
`;

let smartbedTitle = "";
let smartbedSub = "";
let smartbedImageUrl = "";
let foundSmartbedData = false;

try {
  const languageData = await wpQuery<any>(SMARTBED_LANGUAGE_QUERY, { language: languageFilter });
  const pages = languageData?.pages?.nodes || [];
  const target = pages.find((p: any) => p.smartbed && (p.smartbed.smartbedtitle || p.smartbed.smartbedimage));
  if (target?.smartbed) {
    smartbedTitle = target.smartbed?.smartbedtitle || smartbedTitle;
    smartbedSub = target.smartbed?.smartbedsub || smartbedSub;
    smartbedImageUrl = pickImageUrl(target.smartbed?.smartbedimage) || smartbedImageUrl;
    if (smartbedTitle || smartbedSub || smartbedImageUrl) foundSmartbedData = true;
  }
} catch (e) {
  console.warn("[SMARTBED] Language query failed:", e);
}

if (!foundSmartbedData) {
  for (const uri of uriCandidates) {
    try {
      const data = await wpQuery<any>(SMARTBED_URI_QUERY, { uri });
      const sb = data?.nodeByUri?.smartbed;
      if (!sb) continue;
      smartbedTitle = sb?.smartbedtitle || smartbedTitle;
      smartbedSub = sb?.smartbedsub || smartbedSub;
      smartbedImageUrl = pickImageUrl(sb?.smartbedimage) || smartbedImageUrl;
      if (smartbedTitle || smartbedSub || smartbedImageUrl) { foundSmartbedData = true; break; }
    } catch {}
  }
}
---

<section class="bg-white overflow-x-clip smartbed-section">
  <div class="container-primary smartbed-container">
    <div class="relative overflow-hidden shadow-2xl md:min-h-[680px] lg:min-h-[760px] smartbed-card">
      
      <!-- Desktop: Background Image -->
      {smartbedImageUrl ? (
        <img
          src={smartbedImageUrl}
          alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          class="absolute inset-0 w-full h-full object-cover desktop-only desktop-bg"
          loading="lazy"
        />
      ) : (
        <div class="absolute inset-0 bg-blue-200 desktop-only" />
      )}

      <!-- Desktop Content -->
      <div class="relative z-10 grid lg:grid-cols-2 items-center gap-8 p-10 md:p-16 lg:p-20 desktop-only">
        <div class="max-w-xl lg:max-w-2xl text-white">
          <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
            {lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          </h2>
          <h3 class="text-xl md:text-2xl lg:text-3xl font-medium mb-8">
            {smartbedTitle ||
              (lang === "en"
                ? "Innovative Care for the Ones Your loved ones"
                : <>นวัตกรรมดูแลสุขภาพ <br /><span class="font-light">ของคนที่คุณรัก</span></>)}
          </h3>
          <p class="text-base md:text-lg/8 lg:text-xl/9 mb-10 opacity-95">
            {smartbedSub ||
              (lang === "en"
                ? "The smart bed is an electric bed that distributes pressure and supports caregivers in repositioning patients. With IoT integration, it can be controlled remotely via smartphone. Embedded technology enhances its intelligence, enabling seamless connection and interaction with other devices."
                : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย ด้วยการผสาน IOT สามารถควบคุมระยะไกลผ่านสมาร์ทโฟน เทคโนโลยีฝังตัวช่วยเพิ่มความอัจฉริยะ ทำให้เชื่อมต่อและโต้ตอบกับอุปกรณ์อื่นได้อย่างราบรื่น")}
          </p>

          <a
            href="#footer"
            class="group inline-flex items-center gap-3 px-8 py-4 rounded-full
                   border-2 border-[#00D2E6] bg-white text-[#00D2E6]
                   font-semibold text-lg shadow-md transition-all duration-300
                   hover:bg-[#00D2E6] hover:text-white hover:shadow-lg"
          >
            {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path strokeLinecap="round" strokeLinejoin="round" d="M3 12h16" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M13 6l6 6-6 6" />
            </svg>
          </a>
        </div>
        <div class="hidden lg:block"></div>
      </div>

      <!-- Mobile Content -->
      <div class="mobile-only mobile-wrapper">
        <div class="mobile-header">
          <h2 class="mobile-title">{lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}</h2>
          <h3 class="mobile-subtitle">
            {smartbedTitle ||
              (lang === "en"
                ? "Innovative Care for the Ones Your loved ones"
                : <>นวัตกรรมดูแลสุขภาพ<br /><span class="thin">ของคนที่คุณรัก</span></>)}  
          </h3>
        </div>

        {smartbedImageUrl && (
          <div class="mobile-image-box">
            <img src={smartbedImageUrl} alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"} class="mobile-image" loading="lazy" />
          </div>
        )}

        <div class="mobile-text">
          <p>
            {smartbedSub ||
              (lang === "en"
                ? "The smart bed is an electric bed that distributes pressure and supports caregivers in repositioning patients."
                : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย ด้วยการผสาน IOT สามารถควบคุมระยะไกลผ่านสมาร์ทโฟน")}
          </p>
        </div>

        <div class="mobile-button-box">
          <a href="#footer" class="mobile-btn">
            {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .mobile-only { display: none; }

  /* ===== Desktop only: ครอปรูปด้านล่างให้ชิดปุ่ม ===== */
  @media (min-width: 1024px) {
    .smartbed-card {
      --sb-crop-bottom: 160px; /* ปรับได้ 120–200 เพื่อขยับรูปขึ้น */
      margin-bottom: calc(-1 * var(--sb-crop-bottom));
      border-radius: 24px;
      overflow: hidden;
    }
    .smartbed-card > img.desktop-bg {
      object-fit: cover;
      object-position: center;
      clip-path: inset(0 0 var(--sb-crop-bottom) 0);
      will-change: clip-path;
    }
    .smartbed-container { padding-bottom: 0 !important; }
    .smartbed-section + * { margin-top: 0 !important; }
  }

  /* ===== MOBILE ===== */
  @media (max-width: 767.98px) {
    .desktop-only { display: none !important; }
    .mobile-only  { display: block !important; }
  }
  
  /* ปรับเลขเดียว: ระยะที่อยาก “ตัดออก” จากด้านล่างของกรอบ */
@media (min-width:1024px){
  .smartbed-section{ --cut: 200px; }            /* 120–200 ลองจูนได้ */

  /* ตัดเฉพาะล่างของกรอบ ไม่แตะรูป */
  .smartbed-card{
    clip-path: inset(0 0 var(--cut) 0);
    transform: translateZ(0);                    /* กันเส้นบาง ๆ */
  }

  /* ดึงบล็อกถัดไปขึ้นมาปิดช่องว่าง */
  .smartbed-section{ 
    margin-bottom: calc(-1 * var(--cut));
  }

  /* กันบล็อกถัดไปมี margin/padding-top เพิ่ม */
  .smartbed-section + *{
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
}
  
</style>
