---
// src/components/SmartBedSection.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props { lang: "th" | "en" }

const { lang = "th" } = Astro.props;
const languageFilter = lang.toUpperCase() as "TH" | "EN";

type Size = { name: string; sourceUrl?: string; width?: number; height?: number };
type Img  = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined { return img?.node ? img.node : (img ?? undefined); }
function pick(img: any): string | undefined {
  const n = normalize(img); if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s)=>s?.name===key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

const Q = /* GraphQL */ `
  query SmartBed($language: LanguageCodeFilterEnum!) {
    pages(first: 10, where: { language: $language, status: PUBLISH }) {
      nodes {
        smartbed {
          smartbedtitle
          smartbedsub
          smartbedimage { node { altText sourceUrl mediaDetails { sizes { name width height sourceUrl } } } }
        }
      }
    }
  }
`;

let smartbedTitle = "", smartbedSub = "", smartbedImageUrl = "";
try {
  const data = await wpQuery<any>(Q, { language: languageFilter });
  const sb = data?.pages?.nodes?.[0]?.smartbed;
  if (sb) {
    smartbedTitle   = sb.smartbedtitle ?? "";
    smartbedSub     = sb.smartbedsub   ?? "";
    smartbedImageUrl = pick(sb.smartbedimage) ?? "";
  }
} catch (e) { console.warn("[SMARTBED] query failed:", e); }
---

<section class="smartbed-section bg-white overflow-x-clip">
  <div class="container-primary smartbed-container">
    <div class="relative overflow-hidden shadow-2xl md:min-h-[680px] lg:min-h-[760px] smartbed-card">

      <!-- ===== Desktop (ไม่แตะต้อง) ===== -->
      {smartbedImageUrl ? (
        <img
          src={smartbedImageUrl}
          alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          class="absolute inset-0 w-full h-full object-cover desktop-only desktop-bg"
          loading="lazy"
        />
      ) : (
        <div class="absolute inset-0 bg-blue-200 desktop-only" />
      )}

      <div class="relative z-10 grid lg:grid-cols-2 items-center gap-8 p-10 md:p-16 lg:p-20 desktop-only">
        <div class="max-w-xl lg:max-w-2xl text-white">
          <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
            {lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
          </h2>
          <h3 class="text-xl md:text-2xl lg:text-3xl font-medium mb-8">
            {smartbedTitle ||
              (lang === "en"
                ? <>Innovative Care<br/>for your loved ones</>
                : <>นวัตกรรมดูแลสุขภาพ<br/>ของคนที่คุณรัก</>)}
          </h3>
          <p class="text-base md:text-lg/8 lg:text-xl/9 mb-10 opacity-95">
            {smartbedSub ||
              (lang === "en"
                ? "The smart bed is an electric bed that distributes pressure and supports caregivers..."
                : "เตียงอัจฉริยะเป็นเตียงไฟฟ้าที่กระจายแรงกดและสนับสนุนผู้ดูแลในการจัดท่าผู้ป่วย...")}
          </p>

          <a
            href="#footer"
            class="group inline-flex items-center gap-3 px-8 py-4 rounded-full
                   bg-white text-[#00D2E6] font-light text-lg shadow-md
                   transition-all duration-300 hover:bg-[#00D2E6] hover:text-white hover:shadow-xl"
          >
            {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 transition-transform duration-300 group-hover:translate-x-1"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h16" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 6l6 6-6 6" />
            </svg>
          </a>
        </div>
        <div class="hidden lg:block"></div>
      </div>

      <!-- ===== Mobile (ภาพเต็มกรอบ) ===== -->
      <div class="mobile-only">
        <div class="mwrap">
          {smartbedImageUrl && (
            <img
              src={smartbedImageUrl}
              alt={lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}
              class="m-bg" loading="lazy"
            />
          )}

          <!-- mask ไล่เฉดด้านซ้ายให้ตัวอักษรชัด -->
          <div class="m-dim" aria-hidden="true"></div>

          <div class="m-copy">
            <h2 class="m-title">{lang === "en" ? "Smart Bed" : "เตียงอัจฉริยะ"}</h2>
            <h3 class="m-sub">
              {smartbedTitle ||
                (lang === "en"
                  ? <>Innovative Care<br/>for your loved ones</>
                  : <>นวัตกรรมดูแลสุขภาพ<br/><span class="thin">ของคนที่คุณรัก</span></>)}
            </h3>
            <p class="m-desc">
              {smartbedSub ||
                (lang === "en"
                  ? "The smart bed distributes pressure and supports caregivers in repositioning patients with IoT integration."
                  : "เตียงอัจฉริยะกระจายแรงกด สนับสนุนการจัดท่าผู้ป่วย พร้อม IOT ควบคุมผ่านสมาร์ทโฟน")}
            </p>

            <a href="#footer" class="m-cta">
              {lang === "en" ? "Contact Us" : "ติดต่อเรา"}
              <svg class="m-cta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h16" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 6l6 6-6 6" />
              </svg>
            </a>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<style>
  .mobile-only { display: none; }

  /* ===== Desktop (คงเดิมทุกอย่าง) ===== */
  @media (min-width: 1024px) {
    .smartbed-card {
      border-radius: 40px;
      overflow: hidden;
      position: relative;
      clip-path: inset(0 0 200px 0);
      margin-bottom: -200px;
    }
    .desktop-bg { object-fit: cover; object-position: center; }
    .smartbed-section + * { margin-top: 0 !important; }
  }

  /* ===== Mobile: ภาพเต็มกรอบ + ชิดขวา ===== */
  @media (max-width: 1023.98px) {
    .desktop-only { display: none !important; }
    .mobile-only  { display: block !important; }

    .mwrap{
      position: relative;
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      border-radius: 28px;
      overflow: hidden;
      margin-top: clamp(10px, 3vw, 18px);
      margin-bottom: clamp(16px, 4vw, 24px);
      min-height: clamp(520px, 140vw, 620px);
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
      isolation: isolate;
    }

    /* ภาพเต็มการ์ด (ไม่มี scale), โฟกัสขวาให้เห็นคนไข้เต็ม ๆ */
    .m-bg{
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      object-position: right center;   /* โฟกัสไปทางคนที่นอน */
      transform: none;                 /* ยกเลิกการขยายเดิม */
      z-index: 0;
      display:block;
    }

    /* เลเยอร์มืดทางซ้ายเพื่อให้อ่านข้อความชัด */
    .m-dim{
      position: absolute; inset: 0 auto 0 0;
      width: clamp(55%, 68vw, 74%);
      z-index: 1; pointer-events: none;
      background:
        radial-gradient(120% 120% at 14% 16%, rgba(0,0,0,.46) 0%, rgba(0,0,0,.32) 45%, rgba(0,0,0,.12) 70%, rgba(0,0,0,0) 100%),
        linear-gradient(90deg, rgba(0,0,0,.55) 0%, rgba(0,0,0,.38) 55%, rgba(0,0,0,.12) 80%, rgba(0,0,0,0) 100%);
    }

    .m-copy{
      position: relative; z-index: 2; color: #fff;
      padding: 24px 20px 26px;
      max-width: 75%;                  /* เว้นพื้นที่ให้ภาพด้านขวา */
      text-shadow: 0 1px 2px rgba(0,0,0,.40);
    }
    .m-title{ font-weight: 800; font-size: 26px; line-height: 1.2; margin-bottom: 10px; }
    .m-sub{ font-weight: 600; font-size: 16px; line-height: 1.38; margin-bottom: 14px; }
    .m-sub .thin{ font-weight: 300; }
    .m-desc{ font-size: 14px; line-height: 1.55; margin-bottom: 18px; }

    .m-cta{
      display: inline-flex; align-items: center; gap: 10px;
      background: #fff; color: #00D2E6;
      padding: 12px 18px; border-radius: 999px; font-weight: 700;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .m-cta:hover{ transform: translateY(-1px); box-shadow: 0 16px 28px rgba(0,0,0,.18); }
    .m-cta-icon{ width: 18px; height: 18px; }
  }
</style>
