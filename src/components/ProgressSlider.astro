---
// src/components/ProgressCarousel.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  categorySlug: string;
  limit?: number;
  class?: string;
}

const { lang, categorySlug, limit = 6, class: sectionClass = "" } = Astro.props;

const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($slug: String!, $limit: Int) {
    posts(
      first: $limit
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        uri
        excerpt
        content
        featuredImage { node { altText sourceUrl mediaDetails { sizes { name sourceUrl width height } } } }
        progressExtras {
          logo1 { node { altText sourceUrl } }
          logo2 { node { altText sourceUrl } }
          logo3 { node { altText sourceUrl } }
          logo4 { node { altText sourceUrl } }
        }
      }
    }
  }
`;

type Size = { name: string; sourceUrl?: string };
type Img  = { altText?: string; sourceUrl?: string; mediaDetails?: { sizes?: Size[] } };

function normalize(img: any): Img | undefined { return img?.node ? img.node : img ?? undefined; }
function pickImageUrl(img: any): string | undefined {
  const n = normalize(img);
  if (!n) return undefined;
  const sizes = n.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "2048x2048", "1536x1536", "medium"];
  for (const key of prefer) {
    const hit = sizes.find((s) => s?.name === key && s?.sourceUrl);
    if (hit?.sourceUrl) return rewriteWpUrl(hit.sourceUrl);
  }
  return n.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

/** ถอดรหัส HTML entities (รวม &lt;br/&gt; → <br/>) */
function decodeEntities(s: string): string {
  if (!s) return "";
  return s
    .replace(/&#x([0-9a-fA-F]+);/g, (_, h) => String.fromCodePoint(parseInt(h, 16)))
    .replace(/&#(\d+);/g, (_, d) => String.fromCodePoint(parseInt(d, 10)))
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&quot;/g, '"')
    .replace(/&apos;/g, "'")
    .replace(/&rsquo;/g, "’")
    .replace(/&lsquo;/g, "‘")
    .replace(/&rdquo;/g, "”")
    .replace(/&ldquo;/g, "“");
}

/** สร้าง HTML ที่ปลอดภัย + รวมบรรทัดตามกติกา */
function toSafeHtml(input: string): string {
  let html = decodeEntities(input || "");

  // ตัดแท็ก/คอนเทนต์อันตราย
  html = html
    .replace(/<\s*script[^>]*>[\s\S]*?<\s*\/\s*script\s*>/gi, "")
    .replace(/<\s*style[^>]*>[\s\S]*?<\s*\/\s*style\s*>/gi, "")
    .replace(/<\s*(iframe|form|input|button|svg|math)[^>]*>[\s\S]*?<\s*\/\s*\1\s*>/gi, "")
    .replace(/<\s*(iframe|form|input|button|svg|math)[^>]*\/\s*>/gi, "");

  // ลบ <p> ทั้งหมดและเชื่อมด้วยช่องว่าง
  html = html
    .replace(/<\/p>\s*<p[^>]*>/gi, " ")
    .replace(/<p[^>]*>/gi, "")
    .replace(/<\/p>/gi, "");

  // ถ้าไม่มีแท็กบรรทัด → \n\n = <br/><br/>, \n = ' '
  const hasLineTags = /<(br|ul|ol|li)\b/i.test(html);
  if (!hasLineTags) {
    html = html
      .replace(/\r\n?/g, "\n")
      .replace(/[\u2028\u2029]/g, "\n")
      .replace(/\n{2,}/g, "<br/><br/>")
      .replace(/\n/g, " ");
  }

  // อนุญาตเฉพาะแท็กที่ปลอดภัย
  const ALLOWED = new Set(["br","ul","ol","li","strong","b","em","i","u","a","span"]);
  html = html.replace(/<\/?([a-z0-9-]+)(\s[^>]*)?>/gi, (full, tag: string, attrs: string = "") => {
    const t = tag.toLowerCase();
    if (full.startsWith("</")) return ALLOWED.has(t) ? `</${t}>` : "";
    if (!ALLOWED.has(t)) return "";
    if (t === "a") {
      const m = attrs.match(/\bhref\s*=\s*("([^"]+)"|'([^']+)'|([^\s>]+))/i);
      let href = m?.[2] ?? m?.[3] ?? m?.[4] ?? "";
      href = /^(https?:|mailto:|tel:)/i.test(href) ? href : "#";
      return `<a href="${href}" target="_blank" rel="noopener nofollow">`;
    }
    return `<${t}>`;
  });

  return html
    .replace(/\s+<br\/?>/g, "<br/>")
    .replace(/(<br\/?>\s*){3,}/g, "<br/><br/>")
    .trim();
}

function collectLogos(p: any) {
  const pe = p?.progressExtras;
  return [pe?.logo1, pe?.logo2, pe?.logo3, pe?.logo4]
    .map((x) => x?.node).filter(Boolean)
    .map((n: any) => ({ alt: n?.altText || "logo", src: rewriteWpUrl(n?.sourceUrl || "") }))
    .filter((x) => !!x.src);
}

let posts: any[] = [];
try {
  const res = await wpQuery<any>(POSTS_BY_CATEGORY, { slug: categorySlug, limit });
  posts = res?.posts?.nodes ?? [];
} catch {}

const sectionTitle = lang === "en" ? "Our Latest Progress" : "ความคืบหน้าล่าสุด";
---

<section class={`section-padding-sm pt-0 md:pt-6 pb-0 ${sectionClass}`.trim()}>
  <div class="container-primary">
    <div class="mb-6">
      <h2 class="text-4xl md:text-5xl font-semibold text-gray-900">{sectionTitle}</h2>
    </div>

    {posts.length === 0 ? (
      <div class="rounded-2xl bg-gray-50 border border-gray-200 p-8 text-gray-500">
        {lang === "en" ? "No posts in this category yet." : "ยังไม่มีโพสต์ในหมวดนี้"}
      </div>
    ) : (
      <div class="relative">
        <!-- แทร็คแนวนอนแบบลากอิสระ -->
        <div
          id="progress-track"
          class="drag-scroll flex gap-6 overflow-x-auto pb-4 px-1 hide-scrollbar select-none"
          aria-label={sectionTitle}
        >
          {posts.map((p) => {
            const imgUrl = pickImageUrl(p?.featuredImage);
            const alt    = normalize(p?.featuredImage)?.altText || p?.title || "";
            const raw    = (p?.excerpt || p?.content || "") as string;
            const safe   = toSafeHtml(raw);
            const logos  = collectLogos(p);

            return (
              <article class="shrink-0 w-[94%] sm:w-[78%] lg:w-[1040px] xl:w-[1120px]">
                <div class="pcard">
                  <!-- ปรับสัดส่วนรูป:ข้อความ ให้รูปแคบลง -->
                  <div class="pcard-grid grid
                              md:grid-cols-[0.8fr,1.2fr]
                              lg:grid-cols-[0.75fr,1.25fr]
                              xl:grid-cols-[0.92fr,1.08fr]
                              items-stretch h-full">
                    <figure class="media relative h-full overflow-hidden m-0">
                      {imgUrl ? (
                        <img src={imgUrl} alt={alt} class="block w-full h-full object-cover" loading="lazy" />
                      ) : (<div class="w-full h-full bg-gray-100" />)}
                    </figure>

                    <div class="flex h-full flex-col bg-[#40B4ED] text-white p-5 md:p-6 lg:p-7">
                      <h3 class="text-[18px] md:text-[20px] lg:text-[22px] font-semibold mb-2 leading-tight">
                        {(p?.title || "").split("|").map((chunk, idx) => (
                          <>
                            {idx > 0 && <br />}
                            {chunk.trim()}
                          </>
                        ))} 
                      </h3>

                      {safe && (
                        <div
                          class="html-content text-white/95 text-[13.5px] md:text-[14px] lg:text-[15px] leading-snug"
                          set:html={safe}
                        />
                      )}

                      {logos.length > 0 && (
                        <div class="logos-wrap mt-auto pt-4 md:pt-5 flex flex-wrap items-center gap-4 md:gap-5">
                          {logos.map((lg, i) => (
                            <div class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-white/95 shadow-sm grid place-items-center overflow-hidden" aria-label={`partner-logo-${i + 1}`}>
                              <img src={lg.src} alt={lg.alt} class="max-w-[90%] max-h-[95%] object-contain" loading="lazy" />
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </article>
            );
          })}
        </div>
      </div>
    )}
  </div>
</section>

<style>
  .hide-scrollbar { scrollbar-width: none; }
  .hide-scrollbar::-webkit-scrollbar { height: 0; }

.pcard {
  height: auto;
  background: transparent !important;
  border-radius: 0 !important;
  overflow: visible !important;
}

/* ตรงนี้คือการ์ดที่มองเห็นจริง ๆ = สูง 70% ของ .pcard */
.pcard-grid {
  background: #ffffff;
  border-radius: 22px;
  overflow: hidden;
}

  /* ทำให้ลากได้ทุกจุดของแทร็ค */
  .drag-scroll { cursor: grab; user-select: none; }
  .drag-scroll.dragging { cursor: grabbing; }

  .drag-scroll img {
    -webkit-user-drag: none;
    user-drag: none;
  }

  /* ระยะของคอนเทนต์ HTML ที่มาจาก set:html */
  .html-content { white-space: normal; }
  .html-content p { margin: 0 0 .5rem 0; }
  .html-content ul, .html-content ol { margin: .25rem 0 .5rem 0; padding-left: 1.2rem; }
  .html-content li { margin: .125rem 0; }
  .html-content a { text-decoration: underline; text-underline-offset: 2px; }

  /* ===== MOBILE ONLY ===== */
  @media (max-width: 767.98px) {
    .pcard { overflow: hidden; border-radius: 22px; }
    .pcard .media { margin: 0 !important; }
    .pcard .media > img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }
    .pcard .pcard-grid { gap: 0 !important; }

    .logos-wrap {
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 0.75rem !important;
      justify-content: center !important;
      padding-bottom: 0.5rem !important;
    }
    .logos-wrap::-webkit-scrollbar { display: none; }
    .logos-wrap > div { flex: 0 0 auto !important; }
  }

  /* ===== ปรับสัดส่วนรูปเฉพาะการ์ดใบที่ 1 และ 3 ===== */
@media (min-width: 768px) {
  /* การ์ดใบที่ 1 และ 3 */
  #progress-track article:nth-child(1) .pcard-grid,
  #progress-track article:nth-child(3) .pcard-grid {
    /* ยืดคอลัมน์รูปให้กว้างขึ้น เนื้อหาแคบลง */
    grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.75fr);
  }
}

@media (min-width: 1024px) {
  #progress-track article:nth-child(1) .pcard-grid,
  #progress-track article:nth-child(3) .pcard-grid {
    grid-template-columns: minmax(0, 1.35fr) minmax(0, 0.65fr);
  }
}


</style>

<script>
  // Drag-to-scroll + wheel horizontal
  const track = document.getElementById("progress-track");
  const cards = Array.from(document.querySelectorAll('.pcard-grid')); // ✅ เปลี่ยนมาจับ pcard-grid

  if (track) {
    track.addEventListener("dragstart", (e) => e.preventDefault());
    track.querySelectorAll("img, a, svg").forEach(el => {
      el.setAttribute?.("draggable", "false");
      el.addEventListener("dragstart", (e) => e.preventDefault());
    });

    let isDown = false;
    let startX = 0;
    let startLeft = 0;

    const down = (x) => { isDown = true; startX = x; startLeft = track.scrollLeft; track.classList.add("dragging"); };
    const move = (x, e) => { if (!isDown) return; e?.preventDefault?.(); track.scrollLeft = startLeft - (x - startX); };
    const up   = ()   => { isDown = false; track.classList.remove("dragging"); };

    track.addEventListener("mousedown", (e) => down(e.pageX));
    window.addEventListener("mousemove", (e) => move(e.pageX, e));
    window.addEventListener("mouseup", up);
    track.addEventListener("mouseleave", up);

    track.addEventListener("wheel", (e) => {
      const absY = Math.abs(e.deltaY), absX = Math.abs(e.deltaX);
      if (absY > absX) { track.scrollLeft += e.deltaY; e.preventDefault(); }
    }, { passive: false });
  }

  // ให้การ์ดสูงเท่ากัน + เตี้ยลงเหลือ 70% ของเดิม
  function syncHeights() {
    if (!cards.length) return;
    cards.forEach(c => c.style.height = 'auto');

    let maxH = 0;
    cards.forEach(c => {
      const h = c.getBoundingClientRect().height;
      if (h > maxH) maxH = h;
    });

    // ✅ บีบให้เหลือ 70% ของความสูงสูงสุด
    const target = Math.ceil(maxH * 0.75);
    const px = target + 'px';
    cards.forEach(c => c.style.height = px);
  }

  window.addEventListener('load', syncHeights);
  window.addEventListener('resize', () => {
    clearTimeout(window.__pc_sync);
    window.__pc_sync = setTimeout(syncHeights, 120);
  });
  document.querySelectorAll('.pcard img').forEach(img => {
    if (!img.complete) img.addEventListener('load', () => setTimeout(syncHeights, 30));
  });
  if (document.fonts && document.fonts.ready) { document.fonts.ready.then(syncHeights); }
</script>
