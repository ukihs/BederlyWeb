---
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  limit?: number;
  class?: string;
}

const { lang = "th", limit = 2, class: klass = "" } = Astro.props;

const categoryCandidates =
  lang === "en"
    ? ["moreinfo-en", "moreinfo", "more-info", "Moreinfo"]
    : ["moreinfo-th", "moreinfo", "more-info", "Moreinfo"];

const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($first: Int!, $category: String!) {
    posts(
      first: $first
      where: { categoryName: $category, status: PUBLISH, orderby: { field: DATE, order: DESC } }
    ) {
      nodes {
        id
        title
        uri
        excerpt
        language { code }
        featuredImage {
          node {
            altText
            sourceUrl
            mediaDetails {
              sizes { name width height sourceUrl }
            }
          }
        }
      }
    }
  }
`;

function pickImageUrl(node?: any) {
  if (!node) return undefined;
  const sizes = node.mediaDetails?.sizes ?? [];
  for (const n of ["2048x2048","1536x1536","large","medium_large","medium"]) {
    const s = sizes.find((x:any)=>x?.name===n && x?.sourceUrl);
    if (s) return rewriteWpUrl(s.sourceUrl);
  }
  return node.sourceUrl ? rewriteWpUrl(node.sourceUrl) : undefined;
}

let posts: any[] = [];

for (const cat of categoryCandidates) {
  try {
    const res = await wpQuery<any>(POSTS_BY_CATEGORY, { first: limit, category: cat });
    const found = res?.posts?.nodes ?? [];
    if (found.length) {
      posts = found;
      break;
    }
  } catch {}
}

const fallbackCards = [
  {
    title: lang === "en" ? "For Individuals" : "สำหรับบุคคลทั่วไป",
    subtitle: lang === "en" ? "Mock text" : "ข้อความตัวอย่าง",
    href: "#",
    image: "https://images.unsplash.com/photo-1516617442634-75371039cb3c?q=80&w=1600&auto=format&fit=crop"
  },
  {
    title: lang === "en" ? "For Businesses" : "สำหรับองค์กร",
    subtitle: "Mock text",
    href: "#",
    image: "https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=1600&auto=format&fit=crop"
  }
];
---

<section class={`section-padding bg-white ${klass}`}>
  <div class="container-primary">
    <div class="mb-8">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900">
        {lang === "en" ? "More Info" : "ข้อมูลเพิ่มเติม"}
      </h2>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      {(posts.length ? posts : fallbackCards).map((item) => {
        const title = item.title;
        const excerpt = item.excerpt
          ? (item.excerpt as string).replace(/<[^>]+>/g, "").trim()
          : (item.subtitle ?? "");
        const href = item.uri ?? item.href ?? "#";

        const imgNode = item.featuredImage?.node;
        const img = imgNode ? pickImageUrl(imgNode) : item.image;

        return (
          <a href={href} class="group relative overflow-hidden shadow-xl block">
            <div class="relative aspect-[16/9]">
              <img
                src={img}
                alt={imgNode?.altText || title}
                class="absolute inset-0 h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                loading="lazy"
                decoding="async"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent" />
              <div class="absolute inset-0 flex flex-col justify-end p-6">
                <div class="flex items-center gap-2 text-white/90">
                  <h3 class="text-xl md:text-2xl font-semibold">{title}</h3>
                  <svg class="w-6 h-6 -mr-1 translate-x-0 group-hover:translate-x-1 transition-transform"
                       viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </div>
                {excerpt && (
                  <p class="mt-1 text-sm text-white/80 line-clamp-2">{excerpt}</p>
                )}
              </div>
            </div>
          </a>
        );
      })}
    </div>
  </div>
</section>