---
// src/components/PartnersGroup.astro
import { wpQuery } from "../lib/wp";
import { rewriteWpUrl } from "../lib/wpUrl";

export interface Props {
  lang: "th" | "en";
  categorySlug: string;
  limit?: number;
  class?: string;
  showHeading?: boolean;
  sectionLabel?: string;
}

const {
  lang,
  categorySlug,
  limit = 20,
  class: sectionClass = "",
  showHeading = false,
  sectionLabel = "",
} = Astro.props;

const POSTS_BY_CATEGORY = /* GraphQL */ `
  query PostsByCategory($slug: String!, $limit: Int) {
    posts(
      first: $limit
      where: { status: PUBLISH, categoryName: $slug, orderby: { field: DATE, order: ASC } }
    ) {
      nodes {
        id
        title
        featuredImage {
          node { altText sourceUrl }
        }
      }
    }
  }
`;

function pickImageUrl(img: any): string | undefined {
  const n = img?.node;
  return n?.sourceUrl ? rewriteWpUrl(n.sourceUrl) : undefined;
}

let posts: any[] = [];
try {
  const res = await wpQuery<any>(POSTS_BY_CATEGORY, { slug: categorySlug, limit });
  posts = res?.posts?.nodes ?? [];
} catch {
  posts = [];
}

const bigTitle =
  lang === "en" ? "Our Partners and Customers" : "ลูกค้าและพันธมิตรของเรา";

const bigSubtitle =
  lang === "en"
    ? "Our trusted partners who walk<br />with us on this journey"
    : "พันธมิตรที่เชื่อถือได้และเดินเคียงข้าง<br />เราตลอดเส้นทางนี้";
---

<section class={`section-padding-sm pt-0 md:pt-6 pb-0 ${sectionClass}`.trim()}>
  <div class="container-primary">
    <div class="md:col-span-12">
      <!-- ซ้าย: แสดงเฉพาะหัวข้อใหญ่ -->
      <div class="md:w-3/12">
        {showHeading && (
          <>
            <h2 class="text-4xl md:text-5xl font-bold text-gray-900 leading-tight">
              {bigTitle}
            </h2>
            <p class="text-gray-600 mt-2 md:mt-2.5 leading-relaxed"set:html={bigSubtitle}></p>
          </>
        )}
      </div>

      <!-- ขวา: กริดโลโก้ (และหัวข้อรองถ้ามี) -->
      <div class="mt-6 md:mt-8 flex justify-end">
        <div class="w-full md:w-10/12">
          {sectionLabel && (
            <h3 class="text-xl md:text-2xl font-semibold text-gray-900 leading-tight mb-3 md:mb-4">
              {sectionLabel}
            </h3>
          )}

          {posts.length === 0 ? (
            <div class="rounded-2xl border border-gray-200 bg-gray-50 p-8 text-gray-600 text-center">
              {lang === "en" ? "No logos yet." : "ยังไม่มีโลโก้ในหมวดนี้"}
            </div>
          ) : (
            <div
              class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 sm:gap-6 lg:gap-7"
              aria-label={sectionLabel || bigTitle}
            >
              {posts.map((p) => {
                const imgUrl = pickImageUrl(p?.featuredImage);
                return (
                  <div
                    class="bg-white rounded-2xl shadow-sm ring-1 ring-black/5
                           flex items-center justify-center h-28 sm:h-32 md:h-36 px-6
                           hover:shadow-md transition"
                  >
                    {imgUrl ? (
                      <img
                        src={imgUrl}
                        alt={p?.featuredImage?.node?.altText || p?.title || ""}
                        class="block max-h-full max-w-full object-contain"
                        loading="lazy"
                      />
                    ) : (
                      <span class="text-gray-400 text-sm">{p?.title || "No image"}</span>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>
